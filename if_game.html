<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŒ AI äº’åŠ¨å°è¯´ | ğŸŒ¸ æˆ‘çš„äºŒæ¬¡å…ƒå°çª ğŸŒ¸</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .if-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px 40px;
            background: rgba(255, 255, 255, 0.75); /* Slightly more opaque */
            backdrop-filter: blur(10px) saturate(160%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #333;
        }

        .if-container h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #6a5acd; /* Slate Blue */
            font-size: 1.8em;
            text-shadow: 0 0 8px rgba(106, 90, 205, 0.4);
        }

        /* Setup Area */
        #setup-area, #game-area {
            margin-bottom: 20px;
        }
         #game-area {
             display: none; /* Initially hidden */
         }

        .form-group { /* Reusing style from ai_draw */
            margin-bottom: 20px;
        }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .form-group input[type="text"],
        .form-group input[type="password"], /* Use password type for API key */
        .form-group textarea {
             width: 100%; padding: 12px 15px; border: 1px solid rgba(0, 0, 0, 0.1);
             border-radius: 8px; background: rgba(255, 255, 255, 0.8); outline: none;
             transition: all 0.3s ease; box-sizing: border-box; font-size: 0.95em;
             color: #333; font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus {
             background: rgba(255, 255, 255, 0.95); border-color: rgba(106, 90, 205, 0.7);
             box-shadow: 0 0 10px rgba(106, 90, 205, 0.5);
         }
         .api-key-warning {
             font-size: 0.85em; color: #dc3545; margin-top: 5px; font-weight: bold;
         }

        /* Game Display Area */
        #image-display {
            text-align: center;
            min-height: 250px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        #story-image {
            max-width: 100%;
            max-height: 50vh;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none; /* Hide initially */
            vertical-align: middle;
        }
         #loading-image {
             display: none; /* Hide initially */
             color: #666; animation: pulse 1.5s infinite ease-in-out;
         }


        #story-text-container {
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            min-height: 100px;
            line-height: 1.7;
            font-size: 1.05em;
            position: relative; /* For loading indicator */
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
         #loading-text {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             display: none; color: #666; font-style: italic;
         }
         #story-text {
             white-space: pre-wrap; /* Preserve line breaks from AI */
         }

        #choices-container {
            display: flex;
            flex-direction: column; /* Stack choices vertically */
            gap: 10px;
            align-items: stretch; /* Make buttons full width */
        }

        .choice-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #aeeeee, #87cefa); /* Blue gradient */
            color: #333;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: left; /* Align text left */
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .choice-button:hover {
            background: linear-gradient(135deg, #87cefa, #aeeeee);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            color: #0056b3;
        }
        .choice-button:disabled { background: var(--text-color-lighter); color: var(--text-color); opacity: 0.6; box-shadow: none; transform: none; }
        #start-game-btn { /* Reusing generate button style */
            padding: 12px 25px; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #90ee90, #3cb371); /* Green gradient */
            color: white; font-size: 1.1em; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(60, 179, 113, 0.4);
            margin-top: 10px; display: block; width: 100%;
        }
        #start-game-btn:hover { background: linear-gradient(135deg, #3cb371, #90ee90); box-shadow: 0 8px 20px rgba(60, 179, 113, 0.6); transform: translateY(-3px); }
        #start-game-btn:disabled { background: var(--text-color-lighter); cursor: not-allowed; box-shadow: none; transform: none; opacity: 0.7; }
        #error-message-if { display: none; color: #dc3545; font-weight: bold; margin-top: 15px; text-align: center; background: rgba(255, 220, 220, 0.7); padding: 10px; border-radius: 5px; }
        body.theme-dark #error-message-if { color: #f5c6cb; background: rgba(248, 215, 218, 0.1); }
        /* Styles copied/adapted from tno_generator.html for config */
        .config-section { border: 1px dashed var(--border-color-input); padding: 20px; margin-bottom: 25px; border-radius: 8px; background: rgba(200, 200, 255, 0.05); }
        body.theme-dark .config-section { background: rgba(100, 100, 150, 0.05); }
        .config-section h3 { margin-top: 0; margin-bottom: 15px; color: var(--heading-color-tertiary); font-size: 1.2em; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .form-group { margin-bottom: 0; }
        .form-group label { color: var(--text-color-light); }
        .form-group input[type="text"], .form-group input[type="url"],
        .form-group input[type="password"], .form-group textarea, .form-group select {
            /* Uses general input styles from style.css now */
        }
        .api-key-wrapper { position: relative; display: flex; align-items: center; }
        .api-key-wrapper input { padding-right: 45px; flex-grow: 1; }
        #toggle-api-key-visibility { /* Uses general styles, can keep for specificity */
             position: absolute; right: 1px; top: 50%; transform: translateY(-50%); background: none; border: none;
             cursor: pointer; padding: 10px; color: var(--text-color-lighter); font-size: 1.2em; line-height: 1; opacity: 0.7; transition: opacity 0.2s;
        }
        #toggle-api-key-visibility:hover { opacity: 1; color: var(--text-color); }
        .api-url-wrapper { display: flex; gap: 0; align-items: stretch; }
        .api-url-wrapper input[type="url"] { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
        #fetch-models-btn { /* Uses general button styles now, specific style for background below */
             flex-shrink: 0; padding: 10px 18px; border: 1px solid var(--border-color-input); border-left: none;
             border-top-left-radius: 0; border-bottom-left-radius: 0;
             background: var(--tno-fetch-btn-bg); /* Reuse TNO style */ color: var(--tno-fetch-btn-color);
             cursor: pointer; font-weight: 500; font-size: 0.95em; transition: all 0.3s ease; height: auto;
        }
        #fetch-models-btn:hover { background: var(--tno-fetch-btn-hover-bg); color: var(--tno-fetch-btn-hover-color); }
        #fetch-models-btn:disabled { background: rgba(0,0,0,0.1); color: var(--text-color-lighter); box-shadow: none; opacity: 0.5; }
        #model-loading-indicator { margin-left: 8px; color: var(--text-color-light); font-size: 1.2em; vertical-align: middle; display: none; }
        .form-group .input-hint { font-size: 0.85em; color: var(--text-color-lighter); display:block; margin-top: 5px; }
    </style>
</head>
<body>
    <!-- Background, Sidebar, Toggle Button -->
    <div class="background"></div>
    <div id="sidebar">
        <nav id="sidebar-nav">
            <a href="index.html">ğŸ  ä¸»é¡µ</a>
            <a href="about.html">âœ¨ å…³äºæˆ‘</a>
            <a href="blog_page1.html">ğŸ“ åšå®¢</a>
            <a href="contact.html">ğŸ’Œ è”ç³»æˆ‘</a>
            <a href="download.html">ğŸ“ æ–‡ä»¶ä¸‹è½½</a>
            <a href="ai_draw.html">ğŸ¨ AI ä½œç”»</a>
            <a href="tno_generator.html">ğŸ“œ TNOäº‹ä»¶ç”Ÿæˆ</a>
            <a href="if_game.html">ğŸŒŒ AI äº’åŠ¨å°è¯´</a>
            <a href="ai_rpg.html">ğŸ’– AI Galgame</a>
        </nav>
        <div class="theme-switcher">
            <h4>åˆ‡æ¢ä¸»é¢˜:</h4>
            <div class="theme-buttons-container">
                <button data-theme="pastel" class="theme-button">ğŸŒ¸ ç²‰å½©æ¢¦å¢ƒ</button>
                <button data-theme="dark" class="theme-button">ğŸŒ™ åˆå¤œæ¨±è½</button>
            </div>
        </div>
    </div>
    <button id="toggle-btn">â˜°</button>

    <!-- Page Content -->
    <div class="content scroll-container">
        <header>
            <h1>AI äº’åŠ¨å°è¯´</h1>
        </header>

        <main>
            <div class="if-container">
                <h2>å¼€å§‹ä½ çš„å†’é™©ï¼</h2>

                <!-- Configuration Section -->
                <div class="config-section">
                    <h3>API è®¾ç½®</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="llm-api-key">API å¯†é’¥:</label>
                            <div class="api-key-wrapper">
                                <input type="password" id="llm-api-key" placeholder="è¾“å…¥ API Key (ä¾‹å¦‚ Gemini)">
                                <button id="toggle-api-key-visibility" title="åˆ‡æ¢å¯è§æ€§">ğŸ‘ï¸</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="llm-api-url">API åŸºç¡€åœ°å€:</label>
                            <div class="api-url-wrapper">
                                <input type="url" id="llm-api-url" placeholder="ä¾‹å¦‚: https://generativelanguage.googleapis.com" value="https://generativelanguage.googleapis.com">
                                <button id="fetch-models-btn" title="è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨">è·å–åˆ—è¡¨</button>
                            </div>
                             <small class="input-hint">(Google: ç•™ç©ºæˆ–å¡« ...googleapis.com; OpenAIå…¼å®¹: å¡«åˆ° /v1/ ç»“å°¾)</small>
                        </div>
                        <div class="form-group">
                            <label for="llm-model-select">é€‰æ‹© LLM æ¨¡å‹:</label>
                             <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="select-wrapper" style="flex-grow: 1;">
                                    <select id="llm-model-select" disabled>
                                        <option value="" disabled selected>-- è¯·å…ˆè·å–æ¨¡å‹åˆ—è¡¨ --</option>
                                    </select>
                                </div>
                                <span id="model-loading-indicator" title="æ­£åœ¨åŠ è½½æ¨¡å‹...">ğŸ”„</span>
                             </div>
                        </div>
                         <div class="form-group">
                            <label for="initial-prompt">æ•…äº‹å¼€ç«¯/è®¾å®š:</label>
                             <textarea id="initial-prompt" rows="4" placeholder="æè¿°ä½ æƒ³å¼€å§‹çš„æ•…äº‹åœºæ™¯ã€è§’è‰²æˆ–ä¸»é¢˜..."></textarea>
                         </div>
                    </div>
                    <button id="start-game-btn" disabled>å¼€å¯æ•…äº‹ (è¯·å…ˆé…ç½®API)</button>
                </div>
                <!-- End Configuration Section -->

                <!-- Game Display Area (Hidden initially) -->
                <div id="game-area">
                    <div id="image-display">
                        <span id="loading-image">ğŸ–¼ï¸ åœºæ™¯åŠ è½½ä¸­...</span>
                        <img id="story-image" src="#" alt="æ•…äº‹åœºæ™¯æ’ç”»">
                    </div>
                    <div id="story-text-container">
                         <span id="loading-text">âœï¸ AI æ­£åœ¨æ„æ€æ•…äº‹...</span>
                        <div id="story-text"></div>
                    </div>
                    <div id="choices-container">
                        <!-- Choice buttons will be added here by JS -->
                    </div>
                </div>
                 <div id="error-message-if"></div> <!-- Error display for IF -->
            </div>
        </main>

        <footer>
            <p>Â© 2024 MOLIFULAN's Blog | Interactive Fiction powered by AI</p>
        </footer>
    </div>

    <!-- JS Files -->
    <script src="js/script.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- IF Game Specific JS ---

        // --- DOM Element References ---
        const configSection = document.querySelector('.config-section');
        const gameArea = document.getElementById('game-area');
        const apiKeyInput = document.getElementById('llm-api-key');
        const apiUrlInput = document.getElementById('llm-api-url');
        const fetchModelsBtn = document.getElementById('fetch-models-btn');
        const modelSelect = document.getElementById('llm-model-select');
        const modelLoadingIndicator = document.getElementById('model-loading-indicator');
        const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
        const initialPromptInput = document.getElementById('initial-prompt');
        const startGameBtn = document.getElementById('start-game-btn');
        const imageDisplay = document.getElementById('image-display');
        const storyImage = document.getElementById('story-image');
        const loadingImage = document.getElementById('loading-image');
        const storyTextContainer = document.getElementById('story-text-container');
        const storyTextDiv = document.getElementById('story-text');
        const loadingText = document.getElementById('loading-text');
        const choicesContainer = document.getElementById('choices-container');
        const errorMessageDiv = document.getElementById('error-message-if');

        // --- State Variables ---
        let currentApiKey = null;
        let currentApiUrl = null;
        let currentModel = null;
        let storyHistory = [];
        let isGenerating = false;
        const IF_GAME_STORAGE_PREFIX = 'ifGame_';

        // --- Error & Loading UI ---
        function showError(message) { /* ... (Keep existing implementation) ... */
             errorMessageDiv.textContent = `é”™è¯¯ï¼š${message}`;
             errorMessageDiv.style.display = 'block';
             loadingText.style.display = 'none';
             loadingImage.style.display = 'none';
             isGenerating = false;
             startGameBtn.disabled = !(currentApiKey && currentModel);
         }
        function hideError() { /* ... (Keep existing implementation) ... */
             errorMessageDiv.style.display = 'none'; errorMessageDiv.textContent = '';
        }
        function showLoading(type) { /* ... (Keep existing implementation) ... */
             if (type === 'text') { loadingText.style.display = 'block'; storyTextDiv.textContent = ''; choicesContainer.innerHTML = ''; }
             else if (type === 'image') { loadingImage.style.display = 'block'; storyImage.style.display = 'none'; storyImage.src = '#'; }
         }
        function hideLoading(type) { /* ... (Keep existing implementation) ... */
            if (type === 'text') loadingText.style.display = 'none';
            if (type === 'image') loadingImage.style.display = 'none';
        }

        // --- Configuration Logic (Keep existing) ---
        function saveConfig() { /* ... */
            const apiKey = apiKeyInput.value.trim();
            const apiUrl = apiUrlInput.value.trim() || 'https://generativelanguage.googleapis.com';
            const model = modelSelect.value;
            if (!apiKey || !model) { showError("è¯·å¡«å†™ API Key å¹¶é€‰æ‹©æ¨¡å‹ã€‚"); return; }
            localStorage.setItem(IF_GAME_STORAGE_PREFIX + 'apiKey', apiKey);
            localStorage.setItem(IF_GAME_STORAGE_PREFIX + 'apiUrl', apiUrl);
            localStorage.setItem(IF_GAME_STORAGE_PREFIX + 'model', model);
            currentApiKey = apiKey; currentApiUrl = apiUrl; currentModel = model;
            startGameBtn.disabled = false; startGameBtn.textContent = 'å¼€å¯æ•…äº‹';
            alert("è®¾ç½®å·²ä¿å­˜ï¼"); console.log("IF Config saved:", { currentApiKey, currentApiUrl, currentModel });
        }
        function loadConfig() { /* ... */
            currentApiKey = localStorage.getItem(IF_GAME_STORAGE_PREFIX + 'apiKey') || '';
            currentApiUrl = localStorage.getItem(IF_GAME_STORAGE_PREFIX + 'apiUrl') || 'https://generativelanguage.googleapis.com';
            currentModel = localStorage.getItem(IF_GAME_STORAGE_PREFIX + 'model') || '';
            apiKeyInput.value = currentApiKey;
            apiUrlInput.value = currentApiUrl === 'https://generativelanguage.googleapis.com' ? '' : currentApiUrl;
            modelSelect.innerHTML = '<option value="" disabled selected>-- è·å–æˆ–é€‰æ‹©æ¨¡å‹ --</option>';
            if(currentModel) {
                 const tempOption = document.createElement('option'); tempOption.value = currentModel;
                 tempOption.textContent = currentModel + " (å·²ä¿å­˜)"; tempOption.selected = true;
                 modelSelect.appendChild(tempOption); modelSelect.disabled = false;
            } else { modelSelect.disabled = true; }
            startGameBtn.disabled = !(currentApiKey && currentModel);
            startGameBtn.textContent = (currentApiKey && currentModel) ? 'å¼€å¯æ•…äº‹' : 'å¼€å¯æ•…äº‹ (è¯·å…ˆé…ç½®API)';
            console.log("IF Config loaded:", { currentApiKey, currentApiUrl, currentModel });
        }
        async function fetchLLMModels() { /* ... (Keep existing implementation) ... */
             const apiKey = apiKeyInput.value.trim(); const baseApiUrl = apiUrlInput.value.trim() || 'https://generativelanguage.googleapis.com';
             if (!apiKey) { showError('è¯·å…ˆå¡«å†™ API å¯†é’¥ã€‚'); return; }
             hideError(); modelLoadingIndicator.style.display = 'inline-block';
             fetchModelsBtn.disabled = true; modelSelect.disabled = true;
             modelSelect.innerHTML = '<option value="" disabled selected>-- æ­£åœ¨è·å–... --</option>';
             let modelListUrl = ''; let headers = { 'Content-Type': 'application/json' }; let method = 'GET';
             try {
                 if (baseApiUrl.includes('generativelanguage.googleapis.com')) { modelListUrl = baseApiUrl.replace(/\/$/, '') + `/v1beta/models?key=${apiKey}&pageSize=1000`; }
                 else if (baseApiUrl.includes('/v1')) { headers['Authorization'] = `Bearer ${apiKey}`; modelListUrl = baseApiUrl.replace(/\/v1\/?$/, '') + '/v1/models'; }
                 else { console.warn("æœªçŸ¥åœ°å€æ ¼å¼ï¼Œå°è¯• /v1/models"); headers['Authorization'] = `Bearer ${apiKey}`; modelListUrl = baseApiUrl.replace(/\/$/, '') + '/v1/models'; }
                 const response = await fetch(modelListUrl, { method, headers });
                 if (!response.ok) { const e = await response.text(); throw new Error(`è·å–å¤±è´¥: ${response.status}. ${e.substring(0,100)}`); }
                 const data = await response.json(); let modelNames = [];
                 if (data.models?.length) modelNames = data.models.map(m => m.name?.replace(/^models\//, '')).filter(Boolean).filter(name => !/embed|vision|instruct|text-|aqa/i.test(name)).sort();
                 else if (data.data?.length) modelNames = data.data.map(m => m.id).filter(Boolean).filter(id => !/embed|vision|instruct|text-|whisper|tts|davinci|babbage|curie|ada/i.test(id)).sort();
                 else throw new Error("æ— æ³•è¯†åˆ«çš„æ¨¡å‹åˆ—è¡¨æ ¼å¼ã€‚");
                 if (modelNames.length === 0) throw new Error("æœªæ‰¾åˆ°å¯ç”¨èŠå¤©æ¨¡å‹ã€‚");
                 const previouslySelected = currentModel || modelSelect.value;
                 modelSelect.innerHTML = '<option value="" disabled>-- è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ --</option>'; let foundPrevious = false;
                 modelNames.forEach(name => { const o=document.createElement('option'); o.value=name; o.textContent=name; if(name === previouslySelected) { o.selected = true; foundPrevious = true; } modelSelect.appendChild(o); });
                 if (!foundPrevious && modelSelect.options.length > 1) { modelSelect.selectedIndex = 1; } else if (!foundPrevious && modelSelect.options.length === 1) { modelSelect.selectedIndex = 0; }
                 currentModel = modelSelect.value; modelSelect.disabled = false; hideError();
             } catch (error) { console.error("è·å–æ¨¡å‹å‡ºé”™:", error); showError(error.message || "è·å–æ¨¡å‹æ—¶å‡ºé”™ã€‚");
             } finally { modelLoadingIndicator.style.display = 'none'; fetchModelsBtn.disabled = false; }
        }
        // API Key visibility toggle
        if (toggleApiKeyVisibilityBtn && apiKeyInput) { toggleApiKeyVisibilityBtn.addEventListener('click', () => { const isPassword = apiKeyInput.type === 'password'; apiKeyInput.type = isPassword ? 'text' : 'password'; toggleApiKeyVisibilityBtn.textContent = isPassword ? 'ğŸ‘ï¸â€ğŸ—¨ï¸' : 'ğŸ‘ï¸'; }); }

        // --- API Call Function (MODIFIED) ---
        async function callLLMApi(promptHistory) {
            if (!currentApiKey || !currentModel || !currentApiUrl) { throw new Error("API é…ç½®ä¸å®Œæ•´ï¼è¯·æ£€æŸ¥è®¾ç½®ã€‚"); }
            if (isGenerating) return null;
            isGenerating = true;
            hideError();
            showLoading('text');

            let finalApiUrl = currentApiUrl.trim();
            let requestBody;
            let headers = { 'Content-Type': 'application/json' };

            const systemInstruction = `ä½ æ˜¯ä¸€ä¸ªäº’åŠ¨å°è¯´å¼•æ“ã€‚æ ¹æ®ç”¨æˆ·æä¾›çš„å†å²è®°å½•å’Œæœ€æ–°é€‰æ‹©ï¼Œç»§ç»­æ•…äº‹ã€‚\nä½ çš„å›ç­”å¿…é¡»æ˜¯ JSON æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š\n1. "story_text": (string) æ•…äº‹çš„ä¸‹ä¸€éƒ¨åˆ†ï¼Œç”ŸåŠ¨æè¿°å½“å‰åœºæ™¯å’Œäº‹ä»¶ã€‚ä½¿ç”¨ Markdown æ ¼å¼åŒ–ï¼Œä¾‹å¦‚ç”¨ *æ–œä½“* è¡¨ç¤ºæƒ³æ³•ã€‚\n2. "image_prompt": (string) ä¸€ä¸ªç®€æ´çš„ã€è‹±æ–‡ã€‘æç¤ºè¯ (å°‘äº25è¯)ï¼Œç”¨äº AI ç»˜ç”»ï¼Œæ¦‚æ‹¬ story_text ä¸­çš„è§†è§‰åœºæ™¯ã€‚\n3. "choices": (array of strings) 2åˆ°4ä¸ªä¾›ç”¨æˆ·é€‰æ‹©çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨é€‰é¡¹ã€‚å¦‚æœæ•…äº‹è‡ªç„¶ç»“æŸï¼Œå¯ä»¥è¿”å›ç©ºæ•°ç»„ []ã€‚`;

            try {
                // Determine API type and construct request (Keep existing logic)
                if (finalApiUrl.includes('generativelanguage.googleapis.com')) {
                     if (!finalApiUrl.includes('/v1beta/models')) { finalApiUrl = finalApiUrl.replace(/\/$/, '') + `/v1beta/models/${currentModel}:generateContent?key=${currentApiKey}`; }
                     else { finalApiUrl = finalApiUrl.replace(/\/$/, '') + `?key=${currentApiKey}`; }
                     requestBody = JSON.stringify({ contents: [ ...promptHistory, { role: "user", parts: [{ text: systemInstruction + `\n\nè¯·æ ¹æ®ä»¥ä¸Šå†å²ç”Ÿæˆä¸‹ä¸€æ­¥çš„JSONå“åº”ã€‚ç”¨æˆ·çš„æœ€åè¾“å…¥/é€‰æ‹©æ˜¯: "${promptHistory[promptHistory.length - 1].parts[0].text}"` }] } ], generationConfig: { responseMimeType: "application/json" } });
                     headers = { 'Content-Type': 'application/json' };
                 } else if (finalApiUrl.includes('/v1')) {
                     headers['Authorization'] = `Bearer ${currentApiKey}`;
                     if (!finalApiUrl.includes('/chat/completions')) { finalApiUrl = finalApiUrl.replace(/\/v1\/?$/, '') + '/v1/chat/completions'; }
                     requestBody = JSON.stringify({ model: currentModel, messages: [ { role: "system", content: systemInstruction }, ...promptHistory.map(h => ({ role: h.role, content: h.parts[0].text })) ], response_format: { type: "json_object" } });
                 } else { throw new Error("æ— æ³•è¯†åˆ«çš„ API åŸºç¡€åœ°å€æ ¼å¼ã€‚"); }

                console.log("Calling LLM API:", finalApiUrl);
                const response = await fetch(finalApiUrl, { method: 'POST', headers, body: requestBody });

                if (!response.ok) {
                    let errorText = `API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`;
                    try { const errorBody = await response.json(); errorText += `\nDetails: ${errorBody?.error?.message || JSON.stringify(errorBody)}`; } catch (_) { try { errorText += `\nDetails: ${await response.text()}`; } catch (e) {} }
                    throw new Error(errorText);
                }

                const data = await response.json();
                console.log("LLM Raw Response:", data);

                let responseText;
                if (data.candidates?.[0]?.content?.parts?.[0]?.text) { responseText = data.candidates[0].content.parts[0].text; }
                else if (data.choices?.[0]?.message?.content) { responseText = data.choices[0].message.content; }
                else { throw new Error("æ— æ³•ä» API å“åº”ä¸­æå–æœ‰æ•ˆæ–‡æœ¬ã€‚"); }
                console.log("Extracted Response Text:", responseText);

                // --- *** NEW CODE: Clean the response text *** ---
                const cleanedText = responseText.replace(/^```json\s*|```$/gs, '').trim();
                console.log("Cleaned Text for Parsing:", cleanedText);
                // --- *** END NEW CODE *** ---

                let parsedResponse;
                try {
                    // --- *** MODIFIED CODE: Parse the cleaned text *** ---
                    parsedResponse = JSON.parse(cleanedText);
                    if (!parsedResponse.story_text || !parsedResponse.image_prompt || !Array.isArray(parsedResponse.choices)) {
                        console.error("Parsed JSON is missing required fields:", parsedResponse)
                        throw new Error("JSON å“åº”ç¼ºå°‘å¿…è¦çš„å­—æ®µ (story_text, image_prompt, choices)ã€‚");
                    }
                } catch (parseError) {
                    console.error("Failed to parse cleaned LLM JSON response:", parseError);
                    console.error("Received raw text:", responseText); // Log original raw text
                    console.error("Attempted to parse:", cleanedText); // Log the text we tried to parse
                    // Display the *cleaned* text in the error fallback
                    storyHistory.push({ role: "model", parts: [{ text: `(AIè¿”å›æ ¼å¼é”™è¯¯):\n${cleanedText}` }] });
                    displayStory(`(AIè¿”å›æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æJSON):\n${cleanedText}`); // Show cleaned text
                    displayChoices([]);
                    callPollinationsAPI("error message, sad anime character");
                    return null;
                }

                storyHistory.push({ role: "model", parts: [{ text: cleanedText }] }); // Store cleaned JSON text
                return parsedResponse;

            } catch (error) {
                console.error("è°ƒç”¨ LLM API æ—¶å‡ºé”™:", error);
                showError(error.message || "ä¸ AI çš„è¿æ¥ä¸­æ–­ã€‚");
                if (storyHistory.length > 0 && storyHistory[storyHistory.length-1].role === 'user') {
                    storyHistory.pop(); // Remove last user prompt on error
                }
                return null;
            } finally {
                 isGenerating = false;
                 // hideLoading('text'); // Let displayStory handle this
            }
        }

        // --- Pollinations API (Keep existing) ---
        function callPollinationsAPI(imagePrompt) { /* ... */
             if (!imagePrompt) return; showLoading('image');
             const encodedPrompt = encodeURIComponent(imagePrompt.trim());
             const width = 512; const height = 512; const model = 'turbo';
             const seed = Math.floor(Math.random() * 1e7);
             const apiUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${width}&height=${height}&model=${model}&seed=${seed}&nologo=true`;
             console.log("Requesting image:", apiUrl); displayImage(apiUrl);
        }

        // --- UI Update Functions (Keep existing) ---
        function displayStory(text) { /* ... */
             hideLoading('text'); storyTextDiv.textContent = text;
        }
        function displayImage(imageUrl) { /* ... */
             storyImage.onload = () => { hideLoading('image'); storyImage.style.display = 'block'; };
             storyImage.onerror = () => { hideLoading('image'); console.warn("Pollinations image failed:", imageUrl); storyImage.style.display = 'none'; };
             storyImage.src = imageUrl;
        }
        function displayChoices(choices) { /* ... */
             choicesContainer.innerHTML = '';
             if (!choices || choices.length === 0) { const endMsg=document.createElement('p'); endMsg.textContent="æ•…äº‹ä¼¼ä¹åˆ°äº†ä¸€ä¸ªèŠ‚ç‚¹..."; endMsg.style.fontStyle='italic'; endMsg.style.textAlign='center'; choicesContainer.appendChild(endMsg); return; }
             choices.forEach(choiceText => { const btn=document.createElement('button'); btn.textContent=choiceText; btn.className='choice-button'; btn.onclick=()=>handleChoice(choiceText); choicesContainer.appendChild(btn); });
         }

        // --- Game Flow Functions (Keep existing) ---
        function startGame() { /* ... */
            if (!currentApiKey || !currentModel) { showError("è¯·å…ˆå®Œæˆå¹¶ä¿å­˜ API é…ç½®ï¼"); return; }
            const initialUserPrompt = initialPromptInput.value.trim();
            if (!initialUserPrompt) { showError("è¯·è¾“å…¥æ•…äº‹çš„å¼€ç«¯æˆ–è®¾å®šã€‚"); initialPromptInput.focus(); return; }
            hideError(); configSection.style.display = 'none'; gameArea.style.display = 'block'; startGameBtn.disabled = true;
            storyHistory = []; // Reset history
            storyHistory.push({ role: "user", parts: [{ text: initialUserPrompt }] });
            advanceStory(initialUserPrompt);
        }
        async function advanceStory(userChoiceOrPrompt) { /* ... */
            // Note: userChoiceOrPrompt is now added to history *before* calling callLLMApi
            const result = await callLLMApi(storyHistory); // Pass entire history
             if (result) {
                 displayStory(result.story_text);
                 displayChoices(result.choices);
                 callPollinationsAPI(result.image_prompt);
             } else { choicesContainer.innerHTML = '<p style="text-align:center; font-style:italic;">å‘ç”Ÿé”™è¯¯ï¼Œæ— æ³•ç»§ç»­æ•…äº‹ã€‚</p>'; }
        }
        function handleChoice(choiceText) { /* ... */
            if (isGenerating) return; console.log("User chose:", choiceText);
            const buttons = choicesContainer.querySelectorAll('button'); buttons.forEach(btn => btn.disabled = true);
            storyHistory.push({ role: "user", parts: [{ text: choiceText }] });
            advanceStory(choiceText);
        }

        // --- Event Listeners (Keep existing) ---
        startGameBtn.addEventListener('click', startGame);
        fetchModelsBtn.addEventListener('click', fetchLLMModels);
        modelSelect.addEventListener('change', saveConfig); // Save on model change
        apiKeyInput.addEventListener('change', saveConfig); // Optional save
        apiUrlInput.addEventListener('change', saveConfig); // Optional save

        // --- Initial Load ---
        loadConfig();

    }); // End DOMContentLoaded
    </script>
</body>
</html>