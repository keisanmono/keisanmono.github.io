<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíñ AI Galgame | üå∏ ÊàëÁöÑ‰∫åÊ¨°ÂÖÉÂ∞èÁ™ù üå∏</title>
    <link rel="stylesheet" href="css/style.css"> <!-- ‰∏ªÁ´ôÊ†∑ÂºèÈìæÊé• -->
    <!-- Marked.js Áî®‰∫éMarkdownÊ∏≤Êüì -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify Áî®‰∫éÂÆâÂÖ®Â§ÑÁêÜ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <!-- KaTeX CSS (ÁßªÈô§ integrity Âíå crossorigin) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">

    <!-- KaTeX JS (ÁßªÈô§ integrity Âíå crossorigin) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>

    <!-- KaTeX Auto-render Extension (ÁßªÈô§ integrity Âíå crossorigin) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <style>
        /* --- Galgame ‰∏ìÁî®Ê†∑Âºè --- */
        /* ‰∏ªÂÆπÂô® */
        #galgame-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 100px);
            min-height: 500px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--galgame-container-shadow, rgba(0, 0, 0, 0.2));
            margin-top: 20px;
        }

        /* ËÉåÊôØÂõæÁâá */
        #game-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--content-bg);
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: background-image 0.8s ease-in-out;
        }

        /* --- ËßíËâ≤Á≤æÁÅµÂå∫Âüü --- */
        .character-area {
            position: absolute;
            bottom: 5%;
            height: 65%;
            width: auto;
            max-width: 40%;
            z-index: 3;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        /* AIËßíËâ≤(Âè≥‰æß) */
        #ai-character-area {
            right: 5%;
            transform: none;
        }

        /* Áé©ÂÆ∂ËßíËâ≤(Â∑¶‰æß) */
        #player-character-area {
            left: 5%;
            transform: none;
        }

        .character-sprite {
            display: block;
            max-height: 100%;
            max-width: 100%;
            height: auto;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(3px 5px 8px rgba(0, 0, 0, 0.4));
            transition: transform 0.4s ease, opacity 0.5s ease;
            opacity: 1;
        }

        /* ÈöêËóèÁ≤æÁÅµÁöÑÁ±ª */
        .character-sprite.hidden {
            opacity: 0;
            transform: scale(0.95);
        }

        /* AIÁ≤æÁÅµÁöÑÁâπÂÆöID */
        #ai-character-sprite {}

        /* Áé©ÂÆ∂Á≤æÁÅµÁöÑÁâπÂÆöID */
        #player-character-sprite {
            /* Ê∞¥Âπ≥ÁøªËΩ¨(Â¶ÇÈúÄË¶Å) */
            /* transform: scaleX(-1); */
        }


        /* ÂØπËØùÊ°Ü */
        #dialogue-box {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 950px;
            min-height: 140px;
            max-height: 38%;
            background: var(--galgame-dialogue-bg, rgba(0, 0, 0, 0.7));
            backdrop-filter: var(--galgame-dialogue-backdrop-filter, blur(10px));
            border-radius: 12px;
            border: 1px solid var(--galgame-dialogue-border, rgba(255, 255, 255, 0.2));
            padding: 20px 30px;
            color: var(--galgame-dialogue-text-color, #fff);
            z-index: 4;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            scrollbar-width: thin;
            scrollbar-color: var(--galgame-scrollbar-thumb-bg, rgba(255, 255, 255, 0.3)) var(--galgame-scrollbar-track-bg, rgba(0, 0, 0, 0.2));
        }

        #dialogue-box::-webkit-scrollbar {
            width: 8px;
        }

        #dialogue-box::-webkit-scrollbar-track {
            background: var(--galgame-scrollbar-track-bg, rgba(0, 0, 0, 0.2));
            border-radius: 4px;
        }

        #dialogue-box::-webkit-scrollbar-thumb {
            background-color: var(--galgame-scrollbar-thumb-bg, rgba(255, 255, 255, 0.3));
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        #dialogue-box::-webkit-scrollbar-thumb:hover {
            background-color: var(--galgame-scrollbar-thumb-hover-bg, rgba(255, 255, 255, 0.5));
        }

        #speaker-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--galgame-speaker-name-color, #ffcc99);
            font-size: 1.15em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        #dialogue-text {
            line-height: 1.7;
            font-size: 1.05em;
        }

        /* MarkdownÊ†∑Âºè */
        #dialogue-text p {
            margin-bottom: 0.8em;
        }

        #dialogue-text h1,
        #dialogue-text h2,
        #dialogue-text h3 {
            margin-top: 0.5em;
            margin-bottom: 0.3em;
            color: var(--galgame-config-link-color, #88aaff);
        }

        #dialogue-text strong {
            color: var(--galgame-speaker-name-color, #ffcc99);
        }

        #dialogue-text em {
            color: #90ee90;
        }

        #dialogue-text ul,
        #dialogue-text ol {
            padding-left: 25px;
            margin-bottom: 0.8em;
        }

        #dialogue-text li {
            margin-bottom: 0.3em;
        }

        #dialogue-text code {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: #f0f0f0;
        }

        #dialogue-text pre {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 0.8em;
        }

        #dialogue-text pre code {
            background: none;
            padding: 0;
        }

        #dialogue-text blockquote {
            border-left: 3px solid var(--galgame-control-btn-bg, #6495ed);
            padding-left: 10px;
            margin: 0.8em 0;
            color: #ccc;
            font-style: italic;
        }

        #dialogue-text a {
            color: var(--galgame-config-link-color, #88aaff);
            text-decoration: underline;
        }

        #dialogue-text a:hover {
            filter: brightness(1.2);
        }

        /* Ê∏∏ÊàèÊéßÂà∂ */
        #game-controls {
            position: absolute;
            bottom: 25px;
            right: 30px;
            z-index: 5;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .control-button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: var(--galgame-control-btn-bg, rgba(100, 149, 237, 0.7));
            color: var(--galgame-control-btn-color, #fff);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
            box-shadow: 0 4px 10px var(--shadow-color-medium, rgba(0, 0, 0, 0.3));
            border: 1px solid var(--galgame-control-btn-border, rgba(255, 255, 255, 0.15));
            backdrop-filter: blur(3px);
        }

        .control-button:hover:not(:disabled) {
            background: var(--galgame-control-btn-hover-bg, rgba(130, 169, 247, 0.85));
            box-shadow: 0 6px 15px var(--shadow-color-dark, rgba(0, 0, 0, 0.4));
            transform: translateY(-2px);
        }

        .control-button:disabled {
            background: var(--text-color-lighter, #999);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }

        #toggle-history-btn {
            background: var(--galgame-history-btn-bg, rgba(75, 75, 75, 0.7));
            color: var(--galgame-history-btn-color, #fff);
        }

        #toggle-history-btn:hover:not(:disabled) {
            background: var(--galgame-history-btn-hover-bg, rgba(95, 95, 95, 0.85));
        }

        /* ÈÄâÊã©ÂÆπÂô® */
        #choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .choice-button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            border: 1px solid var(--galgame-choice-btn-border, rgba(255, 255, 255, 0.2));
            border-radius: 8px;
            background: var(--galgame-choice-btn-bg, rgba(40, 40, 40, 0.8));
            color: var(--galgame-choice-btn-color, #fff);
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.95em;
        }

        .choice-button:hover {
            background: var(--galgame-choice-btn-hover-bg, rgba(80, 80, 80, 0.9));
        }

        /* ÈÖçÁΩÆÈù¢ÊùøÂíåÂÜÖÂÆπ */
        #config-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 350px;
            background: var(--galgame-config-bg, rgba(30, 30, 30, 0.85));
            backdrop-filter: var(--galgame-config-backdrop-filter, blur(10px));
            border-radius: 8px;
            padding: 20px;
            z-index: 10;
            color: var(--galgame-config-text-color, #e0e0e0);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--galgame-config-border, rgba(255, 255, 255, 0.15));
            display: none;
            font-size: 0.9em;
            max-height: 80vh;
            overflow-y: auto;
        }

        #config-panel.visible {
            display: block;
        }

        #config-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            color: var(--galgame-config-link-color, #88aaff);
        }

        #config-panel .form-group {
            margin-bottom: 15px;
        }

        #config-panel label {
            color: var(--galgame-config-label-color, #cccccc);
            margin-bottom: 5px;
            font-size: 0.95em;
            display: block;
        }

        #config-panel input[type="text"],
        #config-panel input[type="password"],
        #config-panel input[type="url"],
        #config-panel .select-wrapper select,
        #config-panel textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            border-radius: 5px;
            background: var(--galgame-config-input-bg, rgba(50, 50, 50, 0.6));
            color: var(--galgame-config-text-color, #e0e0e0);
            font-size: 1em;
            box-sizing: border-box;
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        #config-panel textarea {
            min-height: 60px;
        }

        #config-panel .select-wrapper::after {
            color: var(--galgame-config-label-color, #cccccc);
        }

        #config-panel .config-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        #config-panel button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }

        #save-config-btn {
            background-color: var(--galgame-save-btn-bg, #4caf50);
            color: white;
        }

        #save-config-btn:hover {
            background-color: var(--galgame-save-btn-hover-bg, #3d8b40);
        }

        #close-config-btn {
            background-color: var(--galgame-close-btn-bg, #f44336);
            color: white;
        }

        #close-config-btn:hover {
            background-color: var(--galgame-close-btn-hover-bg, #d32f2f);
        }

        #key-status {
            font-size: 0.85em;
            margin-top: 5px;
            display: inline-block;
            height: 1.2em;
        }

        #key-status.testing {
            color: #ffc107;
        }

        #key-status.valid {
            color: #28a745;
        }

        #key-status.invalid {
            color: #dc3545;
        }

        #key-status.error {
            color: #ff8aae;
        }

        #toggle-config-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 15;
            background: var(--button-glass-bg, rgba(255, 255, 255, 0.15));
            color: var(--button-primary-text, #fff);
            border: 1px solid var(--border-color-light, rgba(255, 255, 255, 0.2));
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #toggle-config-btn:hover {
            background: var(--button-glass-hover-bg, rgba(255, 255, 255, 0.25));
            transform: scale(1.1) rotate(45deg);
        }

        /* Âä†ËΩΩÂíåÈîôËØØË¶ÜÁõñÂ±Ç */
        #game-loading-overlay {
            background: var(--galgame-loading-bg, rgba(0, 0, 0, 0.7));
            color: var(--galgame-loading-text-color, #fff);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
        }

        #game-loading-overlay.visible {
            display: flex;
        }

        #game-loading-overlay span {
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        #game-error-message {
            background: var(--galgame-error-bg, rgba(220, 53, 69, 0.9));
            color: var(--galgame-error-text-color, #fff);
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 20;
            display: none;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* ÂéÜÂè≤Èù¢Êùø */
        #history-panel {
            background: var(--galgame-history-panel-bg, rgba(30, 30, 30, 0.85));
            backdrop-filter: var(--galgame-history-panel-backdrop-filter, blur(10px));
            border: 1px solid var(--galgame-history-panel-border, rgba(255, 255, 255, 0.15));
            color: var(--galgame-history-panel-text-color, #e0e0e0);
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            max-width: 700px;
            height: 70%;
            max-height: 600px;
            border-radius: 10px;
            padding: 25px;
            z-index: 12;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            display: none;
            flex-direction: column;
        }

        #history-panel.visible {
            display: flex;
        }

        #history-panel h3 {
            color: var(--galgame-history-panel-title-color, #88aaff);
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        #history-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
            line-height: 1.6;
            scrollbar-color: var(--galgame-history-scrollbar-thumb-bg, rgba(255, 255, 255, 0.3)) var(--galgame-history-scrollbar-track-bg, rgba(0, 0, 0, 0.2));
        }

        #history-content::-webkit-scrollbar {
            width: 8px;
        }

        #history-content::-webkit-scrollbar-track {
            background: var(--galgame-history-scrollbar-track-bg, rgba(0, 0, 0, 0.2));
            border-radius: 4px;
        }

        #history-content::-webkit-scrollbar-thumb {
            background-color: var(--galgame-history-scrollbar-thumb-bg, rgba(255, 255, 255, 0.3));
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.5);
        }

        #history-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--galgame-history-scrollbar-thumb-hover-bg, rgba(255, 255, 255, 0.5));
        }

        #history-content .history-entry {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.15);
        }

        #history-content .history-entry:last-child {
            border-bottom: none;
        }

        #history-content .history-role-user {
            font-weight: bold;
            color: var(--galgame-history-role-user-color, #88cc88);
            margin-bottom: 5px;
        }

        #history-content .history-role-model {
            font-weight: bold;
            color: var(--galgame-history-role-model-color, #88aaff);
            margin-bottom: 5px;
        }

        /* ÂµåÂ•óÂéÜÂè≤ÊñáÊú¨ÁâáÊÆµ */
        #history-content .history-dialogue-segment {
            margin-left: 10px;
            margin-bottom: 5px;
            font-size: 0.98em;
        }

        #history-content .history-dialogue-segment .segment-speaker {
            font-weight: bold;
            color: var(--galgame-speaker-name-color, #ffcc99);
            margin-right: 5px;
        }

        #history-content .history-dialogue-segment .segment-text {}

        #history-content .history-dialogue-segment .segment-text p {
            margin-bottom: 0.3em;
        }

        #close-history-btn {
            background-color: var(--galgame-history-close-btn-bg, #6c757d);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
            align-self: center;
            flex-shrink: 0;
        }

        #close-history-btn:hover {
            background-color: var(--galgame-history-close-btn-hover-bg, #5a6268);
        }

        /* ÈÖçÁΩÆÂå∫ÂüüÊ†∑Âºè */
        .config-section {
            border: 1px dashed var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: rgba(10, 10, 10, 0.1);
        }

        body.theme-dark .config-section {
            background: rgba(200, 200, 220, 0.05);
        }

        .config-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--galgame-config-link-color, #88aaff);
            border-bottom: 1px solid var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            padding-bottom: 5px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .api-key-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .api-key-wrapper input {
            padding-right: 45px;
            flex-grow: 1;
        }

        #toggle-api-key-visibility {
            position: absolute;
            right: 1px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            color: var(--galgame-config-text-color, #e0e0e0);
            opacity: 0.5;
        }

        #toggle-api-key-visibility:hover {
            opacity: 1;
            color: var(--galgame-config-text-color, #e0e0e0);
        }

        .api-url-wrapper {
            display: flex;
            gap: 0;
            align-items: stretch;
        }

        .api-url-wrapper input[type="url"] {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }

        #fetch-models-btn {
            flex-shrink: 0;
            padding: 8px 15px;
            border: 1px solid var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            border-left: none;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            background: var(--galgame-control-btn-bg, rgba(100, 149, 237, 0.7));
            color: var(--galgame-control-btn-color, #fff);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        #fetch-models-btn:hover {
            background: var(--galgame-control-btn-hover-bg, rgba(130, 169, 247, 0.85));
        }

        #fetch-models-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: var(--galgame-config-label-color, #cccccc);
            box-shadow: none;
            opacity: 0.5;
        }

        #model-loading-indicator {
            margin-left: 8px;
            color: var(--galgame-config-label-color, #cccccc);
            font-size: 1.2em;
            vertical-align: middle;
            display: none;
        }

        .input-hint {
            font-size: 0.85em;
            color: var(--galgame-config-label-color, #cccccc);
            display: block;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* ÂõæÁâá‰∏ä‰º†Ê†∑Âºè */
        .image-upload-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            border: 1px solid var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            padding: 10px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.1);
        }

        body.theme-dark .image-upload-section {
            background: rgba(255, 255, 255, 0.05);
        }

        .image-upload-section input[type="file"] {
            padding: 5px;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            flex-grow: 1;
            cursor: pointer;
            color: var(--galgame-config-label-color, #cccccc);
        }

        .image-upload-section input[type="file"]::file-selector-button {
            padding: 6px 10px;
            border: none;
            background-color: var(--galgame-control-btn-bg, rgba(100, 149, 237, 0.7));
            color: var(--galgame-control-btn-color, #fff);
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }

        .image-upload-section input[type="file"]::file-selector-button:hover {
            background-color: var(--galgame-control-btn-hover-bg, rgba(130, 169, 247, 0.85));
        }

        .image-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .image-preview {
            max-width: 80px;
            max-height: 80px;
            height: auto;
            width: auto;
            border-radius: 4px;
            border: 1px solid var(--galgame-config-input-border, rgba(255, 255, 255, 0.2));
            object-fit: cover;
            display: none;
            /* ÈªòËÆ§ÈöêËóè */
        }

        .clear-image-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
            display: none;
            /* ÈªòËÆ§ÈöêËóè */
        }

        .clear-image-btn:hover {
            background: #5a6268;
        }

        /* ÊïÖ‰∫ãËøõÂ∫¶Êù° */
        .story-progress-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 18px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 9px;
            overflow: hidden;
            z-index: 5;
            border: 1px solid var(--galgame-dialogue-border, rgba(255, 255, 255, 0.2));
        }

        .story-progress-bar .progress-inner {
            height: 100%;
            background: linear-gradient(to right, #4a8af4, #9c59b6);
            transition: width 0.5s ease;
        }

        .story-progress-bar .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: white;
            text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
        }

        /* Á´†ËäÇÊ†áËÆ∞ */
        .chapter-marker {
            display: flex;
            align-items: center;
            margin: 20px 0;
            gap: 15px;
        }

        .chapter-line {
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            flex-grow: 1;
        }

        .chapter-title {
            font-weight: bold;
            color: #ffcc99;
            font-size: 1.1em;
            white-space: nowrap;
            text-shadow: 0px 0px 3px rgba(0, 0, 0, 0.5);
        }

        /* ÈÄâÊã©ÂΩ±ÂìçÊèêÁ§∫ */
        .choice-impact {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            z-index: 10;
            opacity: 1;
            transition: opacity 1s ease;
        }

        .choice-impact.fadeout {
            opacity: 0;
        }

        .choice-impact.relationship-up {
            background: rgba(46, 204, 113, 0.8);
        }

        .choice-impact.relationship-down {
            background: rgba(231, 76, 60, 0.8);
        }

        .choice-impact.story-branch {
            background: rgba(52, 152, 219, 0.8);
        }

        .choice-impact.progress-significant {
            background: rgba(155, 89, 182, 0.8);
        }

        /* ÊïÖ‰∫ãÁªìÂ±ÄÈù¢Êùø */
        .story-ending-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            z-index: 20;
            color: white;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .ending-header {
            margin-bottom: 20px;
        }

        .ending-header h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
            color: #ffcc99;
        }

        .ending-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .ending-type.good {
            background: rgba(46, 204, 113, 0.8);
        }

        .ending-type.neutral {
            background: rgba(241, 196, 15, 0.8);
        }

        .ending-type.bad {
            background: rgba(231, 76, 60, 0.8);
        }

        .ending-content {
            line-height: 1.7;
            margin-bottom: 30px;
            text-align: left;
            max-height: 40vh;
            overflow-y: auto;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        .ending-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .ending-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            background: rgba(100, 149, 237, 0.7);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .ending-buttons button:hover {
            background: rgba(130, 169, 247, 0.85);
            transform: translateY(-2px);
        }

        .restart-button {
            background: #4a8af4 !important;
        }

        .share-button {
            background: #9c59b6 !important;
        }

        /* ËåÉÂõ¥ËæìÂÖ•Ê°ÜÊ†∑Âºè */
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            height: 6px;
            border-radius: 3px;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--galgame-control-btn-bg, rgba(100, 149, 237, 0.7));
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--galgame-control-btn-bg, rgba(100, 149, 237, 0.7));
            cursor: pointer;
            border: none;
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--galgame-config-label-color, #cccccc);
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            #galgame-container {
                height: calc(100vh - 80px);
            }

            .character-area {
                height: 55%;
                max-width: 45%;
            }

            #dialogue-box {
                width: 95%;
                min-height: 120px;
                max-height: 45%;
                padding: 15px 20px;
            }

            #speaker-name {
                font-size: 1.05em;
            }

            #dialogue-text {
                font-size: 0.95em;
            }

            #game-controls {
                bottom: 15px;
                right: 15px;
                gap: 8px;
            }

            .control-button {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            #history-panel {
                width: 90%;
                height: 75%;
            }

            #config-panel {
                width: 90%;
                max-width: 350px;
                right: 50%;
                transform: translateX(50%);
                top: 5%;
            }

            #toggle-config-btn {
                top: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .image-upload-section {
                flex-direction: column;
                align-items: stretch;
            }

            .image-preview {
                max-width: 60px;
                max-height: 60px;
            }

            .story-progress-bar {
                width: 90%;
            }
        }

        @media (max-width: 480px) {
            .character-area {
                height: 50%;
                max-width: 55%;
            }

            #ai-character-area {
                right: 2%;
            }

            #player-character-area {
                left: 2%;
            }

            #dialogue-box {
                max-height: 50%;
                padding: 10px 15px;
            }

            #speaker-name {
                font-size: 1em;
            }

            #dialogue-text {
                font-size: 0.9em;
            }

            .control-button {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            #history-panel {
                width: 95%;
                height: 80%;
                padding: 15px;
            }

            #config-panel {
                padding: 15px;
                width: 95%;
            }

            .image-preview {
                max-width: 50px;
                max-height: 50px;
            }

            #game-controls {
                flex-direction: column;
                right: 10px;
                bottom: auto;
                top: 60px;
                gap: 5px;
            }

            .choice-button {
                padding: 12px 15px;
                margin-bottom: 8px;
            }

            .story-ending-panel {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- ËÉåÊôØ„ÄÅ‰æßËæπÊ†è„ÄÅÂàáÊç¢ÊåâÈíÆ -->
    <div class="background"></div>
    <div id="sidebar">
        <nav id="sidebar-nav">
            <a href="index.html">üè† ‰∏ªÈ°µ</a>
            <a href="about.html">‚ú® ÂÖ≥‰∫éÊàë</a>
            <a href="blog_page1.html">üìù ÂçöÂÆ¢</a>
            <a href="contact.html">üíå ËÅîÁ≥ªÊàë</a>
            <a href="download.html">üìÅ Êñá‰ª∂‰∏ãËΩΩ</a>
            <a href="ai_draw.html">üé® AI ‰ΩúÁîª</a>
            <a href="tno_generator.html">üìú TNO‰∫ã‰ª∂ÁîüÊàê</a>
            <a href="if_game.html">üåå AI ‰∫íÂä®Â∞èËØ¥</a>
            <a href="ai_rpg.html">üíñ AI Galgame</a>
        </nav>
        <div class="theme-switcher">
            <h4>ÂàáÊç¢‰∏ªÈ¢ò:</h4>
            <div class="theme-buttons-container">
                <button data-theme="pastel" class="theme-button">üå∏ Á≤âÂΩ©Ê¢¶Â¢É</button>
                <button data-theme="dark" class="theme-button">üåô ÂçàÂ§úÊ®±ËêΩ</button>
            </div>
        </div>
    </div>
    <button id="toggle-btn">‚ò∞</button>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="content scroll-container">
        <header>
            <h1>AI Galgame ‰∫íÂä®ÊïÖ‰∫ã</h1>
            <button id="toggle-config-btn" title="ËÆæÁΩÆ">‚öô</button> <!-- ËÆæÁΩÆÂàáÊç¢ -->
        </header>

        <main>
            <!-- ÈÖçÁΩÆÈù¢Êùø (Ê∑ªÂä†‰∫ÜÊïÖ‰∫ãËÆæÁΩÆ) -->
            <div id="config-panel">
                <!-- Áé©ÂÆ∂ËÆæÁΩÆÈÉ®ÂàÜ -->
                <div class="config-section">
                    <h4>Áé©ÂÆ∂ËÆæÂÆö</h4>
                    <div class="form-group">
                        <label for="player-name-input">‰Ω†ÁöÑÂêçÂ≠ó:</label>
                        <input type="text" id="player-name-input" placeholder="ËæìÂÖ•‰Ω†ÊÉ≥‰ΩøÁî®ÁöÑÂêçÂ≠ó" aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="player-persona-input">‰Ω†ÁöÑËßíËâ≤ÁÆÄ‰ªã (ÂèØÈÄâÔºåËã•‰∏ä‰º†ÂõæÁâáÂàô‰ºòÂÖà‰ΩøÁî®ÂõæÁâá):</label>
                        <textarea id="player-persona-input" rows="2"
                            placeholder="ÁÆÄÂçïÊèèËø∞‰Ω†ÁöÑËßíËâ≤ (‰æãÂ¶ÇÔºö‰∏Ä‰∏™ÊúâÁÇπÂÜÖÂêë‰ΩÜÂñÑËâØÁöÑÈ´ò‰∏≠Áîü)"></textarea>
                    </div>
                    <!-- Áé©ÂÆ∂ÂõæÁâá‰∏ä‰º† -->
                    <div class="form-group">
                        <label for="player-image-upload">‰∏ä‰º†‰Ω†ÁöÑËßíËâ≤ÂõæÁâá (ÂèØÈÄâ):</label>
                        <div class="image-upload-section">
                            <input type="file" id="player-image-upload" accept="image/png, image/jpeg, image/webp">
                            <div class="image-preview-container">
                                <img id="player-image-preview" class="image-preview" src="#" alt="Áé©ÂÆ∂ÂõæÁâáÈ¢ÑËßà">
                                <button id="clear-player-image-btn" class="clear-image-btn">Ê∏ÖÈô§</button>
                            </div>
                        </div>
                        <small class="input-hint">‰∏ä‰º†ÂõæÁâáÂêéÔºåAI‰ºöÂ∞ùËØïÊ†πÊçÆÂõæÁâáÁîüÊàêÂ§ñË≤åÊèèËø∞„ÄÇ</small>
                    </div>
                    <div class="form-group">
                        <label for="player-start-input">ÊúüÊúõÁöÑÂºÄÂ±Ä:</label>
                        <textarea id="player-start-input" rows="2" placeholder="ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑÂºÄÂú∫Âú∫ÊôØ (‰æãÂ¶ÇÔºöÂú®Êñ∞Â≠¶Ê†°ÁöÑÁ¨¨‰∏ÄÂ§©Ëø∑Ë∑Ø‰∫Ü)"></textarea>
                    </div>
                </div>

                <!-- ÊïÖ‰∫ãËÆæÁΩÆÈÉ®ÂàÜ (Êñ∞Â¢û) -->
                <div class="config-section">
                    <h4>ÊïÖ‰∫ãËÆæÁΩÆ</h4>
                    <div class="form-group">
                        <label for="story-theme-select">ÊïÖ‰∫ã‰∏ªÈ¢ò:</label>
                        <div class="select-wrapper">
                            <select id="story-theme-select">
                                <option value="romance">ÊÅãÁà±ÊïÖ‰∫ã</option>
                                <option value="mystery">ÊÇ¨ÁñëÊé®ÁêÜ</option>
                                <option value="fantasy">Â•áÂπªÂÜíÈô©</option>
                                <option value="school">Ê†°Âõ≠Êó•Â∏∏</option>
                                <option value="scifi">ÁßëÂπªÊú™Êù•</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="story-length-select">ÊïÖ‰∫ãÈïøÂ∫¶:</label>
                        <div class="select-wrapper">
                            <select id="story-length-select">
                                <option value="short">Áü≠ÁØá (5-10ÂàÜÈíü)</option>
                                <option value="medium" selected>‰∏≠ÁØá (10-20ÂàÜÈíü)</option>
                                <option value="long">ÈïøÁØá (20-30ÂàÜÈíü)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="story-complexity-range">ÂâßÊÉÖÂàÜÊîØÂ§çÊùÇÂ∫¶:</label>
                        <input type="range" id="story-complexity-range" min="1" max="5" value="3">
                        <div class="range-labels">
                            <span>ÁÆÄÂçï</span>
                            <span>Â§çÊùÇ</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="character-template-select">ÈÄâÊã©È¢ÑËÆæËßíËâ≤Ê®°Êùø(ÂèØÈÄâ):</label>
                        <div class="select-wrapper">
                            <select id="character-template-select">
                                <option value="" selected>-- ÈÄâÊã©ËßíËâ≤Ê®°Êùø --</option>
                                <option value="tsundere">ÂÇ≤Â®áÂêåÂ≠¶</option>
                                <option value="kuudere">ÂÜ∑ÈÖ∑Â≠¶Âßê</option>
                                <option value="childhood">ÈùíÊ¢ÖÁ´πÈ©¨</option>
                                <option value="teacher">Á•ûÁßòËÄÅÂ∏à</option>
                                <option value="alien">ÂºÇ‰∏ñÁïåÊù•ÂÆ¢</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- AI & APIËÆæÁΩÆÈÉ®ÂàÜ -->
                <div class="config-section">
                    <h4>AI & API ËÆæÁΩÆ</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="galgame-persona">AI ÂØπÊâãËßíËâ≤ËÆæÂÆö (ÂèØÈÄâÔºåËã•‰∏ä‰º†ÂõæÁâáÂàô‰ºòÂÖà‰ΩøÁî®ÂõæÁâá):</label>
                            <textarea id="galgame-persona" rows="2"
                                placeholder="‰Ω†Â∏åÊúõAIÊâÆÊºî‰ªÄ‰πàËßíËâ≤Ôºü(‰æãÂ¶ÇÔºö‰∏Ä‰∏™ÂÇ≤Â®áÁöÑÂêåÁè≠ÂêåÂ≠¶ÔºåÂêçÂè´[‰∫öÈáåÊ≤ô]...)"></textarea>
                        </div>
                        <!-- AI ÂõæÁâá‰∏ä‰º† -->
                        <div class="form-group">
                            <label for="ai-image-upload">‰∏ä‰º†AIËßíËâ≤ÂõæÁâá (ÂèØÈÄâ):</label>
                            <div class="image-upload-section">
                                <input type="file" id="ai-image-upload" accept="image/png, image/jpeg, image/webp">
                                <div class="image-preview-container">
                                    <img id="ai-image-preview" class="image-preview" src="#" alt="AIÂõæÁâáÈ¢ÑËßà">
                                    <button id="clear-ai-image-btn" class="clear-image-btn">Ê∏ÖÈô§</button>
                                </div>
                            </div>
                            <small class="input-hint">‰∏ä‰º†ÂõæÁâáÂêéÔºåAI‰ºöÂ∞ùËØïÊ†πÊçÆÂõæÁâáÁîüÊàêËØ•ËßíËâ≤ÁöÑÂ§ñË≤åÊèèËø∞„ÄÇ</small>
                        </div>
                        <!-- APIÂØÜÈí•„ÄÅURL„ÄÅÊ®°Âûã -->
                        <div class="form-group">
                            <label for="llm-api-key">API ÂØÜÈí•:</label>
                            <div class="api-key-wrapper">
                                <input type="password" id="llm-api-key" placeholder="ËæìÂÖ• API Key (‰æãÂ¶Ç Gemini)">
                                <button id="toggle-api-key-visibility" title="ÂàáÊç¢ÂèØËßÅÊÄß">üëÅÔ∏è</button>
                            </div>
                            <span id="key-status"></span>
                            <button id="test-key-btn" class="control-button"
                                style="padding: 6px 10px; font-size: 0.8em; margin-top: 5px;">ÊµãËØï Key</button>
                        </div>
                        <div class="form-group">
                            <label for="llm-api-url">API Âü∫Á°ÄÂú∞ÂùÄ:</label>
                            <div class="api-url-wrapper">
                                <input type="url" id="llm-api-url"
                                    placeholder="‰æãÂ¶Ç: https://generativelanguage.googleapis.com"
                                    value="https://generativelanguage.googleapis.com">
                                <button id="fetch-models-btn" title="Ëé∑ÂèñÂèØÁî®Ê®°ÂûãÂàóË°®">Ëé∑ÂèñÂàóË°®</button>
                            </div>
                            <small class="input-hint">(Google: ÁïôÁ©∫ÊàñÂ°´ ...googleapis.com; OpenAIÂÖºÂÆπ: Â°´Âà∞ /v1/ ÁªìÂ∞æ)</small>
                        </div>
                        <div class="form-group">
                            <label for="llm-model-select">ÈÄâÊã© LLM Ê®°Âûã:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="select-wrapper" style="flex-grow: 1;">
                                    <select id="llm-model-select" disabled>
                                        <option value="" disabled selected>-- ËØ∑ÂÖàËé∑ÂèñÊ®°ÂûãÂàóË°® --</option>
                                    </select>
                                </div>
                                <span id="model-loading-indicator" title="Ê≠£Âú®Âä†ËΩΩÊ®°Âûã...">üîÑ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-buttons">
                    <button id="save-config-btn">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button id="close-config-btn">ÂÖ≥Èó≠</button>
                </div>
            </div>

            <!-- Galgame UIÂÆπÂô® (Ê∑ªÂä†‰∫ÜÊïÖ‰∫ãËøõÂ∫¶Êù°) -->
            <div id="galgame-container">
                <div id="game-background"></div>
                <!-- Ê∑ªÂä†ÊïÖ‰∫ãËøõÂ∫¶Êù° -->
                <div id="story-progress" class="story-progress-bar" style="display: none;">
                    <div class="progress-inner" style="width: 0%"></div>
                    <span class="progress-text">ÊïÖ‰∫ãËøõÂ∫¶: 0% | Á¨¨1Âπï | Ââ©‰ΩôÂõûÂêà: 0</span>
                </div>
                <div id="player-character-area" class="character-area">
                    <img id="player-character-sprite" src="#" alt="Áé©ÂÆ∂ËßíËâ≤" class="character-sprite hidden">
                </div>
                <div id="ai-character-area" class="character-area">
                    <img id="ai-character-sprite" src="#" alt="AIËßíËâ≤" class="character-sprite hidden">
                </div>
                <div id="dialogue-box">
                    <div id="speaker-name">ÊóÅÁôΩ</div>
                    <div id="dialogue-text">Âú®ËøôÈáåËÆæÁΩÆÁé©ÂÆ∂ÂêçÁß∞„ÄÅËÆæÂÆöÂíåÊúüÊúõÂºÄÂ±ÄÂêéÔºåÁÇπÂáª"ÂºÄÂßã"„ÄÇ</div>
                    <div id="choices-container"></div>
                </div>
                <div id="game-controls">
                    <button id="toggle-history-btn" class="control-button" title="Êü•ÁúãÂØπËØùÂéÜÂè≤" disabled>ÂéÜÂè≤</button>
                    <button id="next-button" class="control-button" disabled>ÂºÄÂßã (ËØ∑ÂÖàËÆæÁΩÆAPI)</button>
                </div>
                <div id="game-loading-overlay"><span>Â∞ëÂ•≥Á•àÁ•∑‰∏≠...</span></div>
                <div id="game-error-message"></div>
            </div>

            <!-- ÂéÜÂè≤Èù¢Êùø -->
            <div id="history-panel">
                <h3>ÂØπËØùÂéÜÂè≤ËÆ∞ÂΩï</h3>
                <div id="history-content"></div>
                <button id="close-history-btn">ÂÖ≥Èó≠</button>
            </div>
        </main>

        <footer>
            <p>¬© 2024 MOLIFULAN's Blog | Galgame powered by AI</p>
        </footer>
    </div>

    <!-- JSÊñá‰ª∂ -->
    <script src="js/script.js"></script> <!-- ‰∏ªÁ´ôËÑöÊú¨ -->
    <script>
        // --- Galgame‰∏ìÁî®JS (Â¢ûÂº∫‰∫ÜÊïÖ‰∫ãËßÑÂàí) ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOMÂÖÉÁ¥†ÂºïÁî® ---
            console.log('DOMContentLoaded ‰∫ã‰ª∂Ëß¶Âèë‰∫Ü„ÄÇÊ£ÄÊü• renderMathInElement Á±ªÂûã:', typeof renderMathInElement); // ‚òÖ Âä†‰∏äËøôË°å
            const configPanel = document.getElementById('config-panel');
            const toggleConfigBtn = document.getElementById('toggle-config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const closeConfigBtn = document.getElementById('close-config-btn');
            const apiKeyInput = document.getElementById('llm-api-key');
            const apiUrlInput = document.getElementById('llm-api-url');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const modelSelect = document.getElementById('llm-model-select');
            const modelLoadingIndicator = document.getElementById('model-loading-indicator');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
            const keyStatusSpan = document.getElementById('key-status');
            const aiPersonaInput = document.getElementById('galgame-persona');
            const playerNameInput = document.getElementById('player-name-input');
            const playerPersonaInput = document.getElementById('player-persona-input');
            const playerStartInput = document.getElementById('player-start-input');
            const dialogueBox = document.getElementById('dialogue-box');
            const speakerName = document.getElementById('speaker-name');
            const dialogueText = document.getElementById('dialogue-text');
            const choicesContainer = document.getElementById('choices-container');
            const nextButton = document.getElementById('next-button');
            const loadingOverlay = document.getElementById('game-loading-overlay');
            const gameErrorMessage = document.getElementById('game-error-message');
            const historyPanel = document.getElementById('history-panel');
            const historyContent = document.getElementById('history-content');
            const toggleHistoryBtn = document.getElementById('toggle-history-btn');
            const closeHistoryBtn = document.getElementById('close-history-btn');
            const gameBackground = document.getElementById('game-background');
            const aiCharacterSprite = document.getElementById('ai-character-sprite');
            const playerCharacterSprite = document.getElementById('player-character-sprite');
            // ÂõæÁâá‰∏ä‰º†ÂÖÉÁ¥†
            const playerImageUpload = document.getElementById('player-image-upload');
            const playerImagePreview = document.getElementById('player-image-preview');
            const clearPlayerImageBtn = document.getElementById('clear-player-image-btn');
            const aiImageUpload = document.getElementById('ai-image-upload');
            const aiImagePreview = document.getElementById('ai-image-preview');
            const clearAiImageBtn = document.getElementById('clear-ai-image-btn');
            // ÊïÖ‰∫ãËÆæÁΩÆÂÖÉÁ¥†
            const storyThemeSelect = document.getElementById('story-theme-select');
            const storyLengthSelect = document.getElementById('story-length-select');
            const storyComplexityRange = document.getElementById('story-complexity-range');
            const characterTemplateSelect = document.getElementById('character-template-select');
            const storyProgressBar = document.getElementById('story-progress');


            // --- Â∏∏Èáè ---
            const FIXED_STYLE_PROMPT = "masterpiece, best quality, ultra-detailed, extremely detailed illustration, high resolution, sharp focus, dramatic lighting, strong highlights, deep contrasting shadows";
            const SPRITE_BACKGROUND_KEYWORDS = "plain white background, isolated on white";
            const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
            const GALGAME_STORAGE_PREFIX = 'galGame_';
            const DEFAULT_API_URL_GALGAME = 'https://generativelanguage.googleapis.com';

            // --- ËßíËâ≤Ê®°Êùø ---
            const characterTemplates = {
                "tsundere": {
                    name: "‰∫öÈáåÊ≤ô",
                    persona: "‰∏Ä‰∏™ÂÇ≤Â®áÁöÑÂêåÁè≠ÂêåÂ≠¶ÔºåÂπ≥Êó∂Ë£Ö‰Ωú‰∏çÂú®ÊÑèÔºå‰ΩÜÂÆûÈôÖ‰∏äÂæàÂÖ≥ÂøÉ‰∏ªËßí„ÄÇÊúâÁùÄÈïøÈïøÁöÑÂèåÈ©¨Â∞æÂíåÁ∫¢Ëâ≤ÁúºÁùõÔºåËØ¥ËØùÊó∂ÁªèÂ∏∏ËÑ∏Á∫¢„ÄÇÊÄßÊ†ºÂÄîÂº∫‰ΩÜÂÜÖÂøÉÊ∏©ÊüîÔºå‰∏çÊìÖÈïøË°®ËææÁúüÂÆûÊÑüÂèó„ÄÇ"
                },
                "kuudere": {
                    name: "Èõ™‰πÉ",
                    persona: "Á•ûÁßòÁöÑÂ≠¶ÂßêÔºåÊÄªÊòØÂú®Âõæ‰π¶È¶ÜÁúã‰π¶ÔºåÁü•ËØÜÊ∏äÂçö‰ΩÜÂæàÂ∞ëËØ¥ËØù„ÄÇÊúâÁùÄÈΩêËÇ©ÁöÑÈªëËâ≤Áü≠ÂèëÂíåÊ∑±ËìùËâ≤ÁúºÁùõÔºåË°®ÊÉÖÂæàÂ∞ëÂèòÂåñ„ÄÇÊÄßÊ†ºÂÜ∑ÈùôÁêÜÊô∫ÔºåÂÜÖÂøÉÊ∑±Â§ÑÊ∏¥ÊúõÊ∏©ÊöñÁöÑÂèãÊÉÖ„ÄÇ"
                },
                "childhood": {
                    name: "Â∞èÊò•",
                    persona: "‰ªéÂ∞è‰∏ÄËµ∑ÈïøÂ§ßÁöÑÈùíÊ¢ÖÁ´πÈ©¨ÔºåÊ¥ªÊ≥ºÂºÄÊúóÔºåÂØπ‰∏ªËßíÈùûÂ∏∏‰∫ÜËß£„ÄÇÊúâÁùÄÊ£ïËâ≤ÁöÑÁü≠ÂèëÂíåÈò≥ÂÖâËà¨ÁöÑÁ¨ëÂÆπ„ÄÇÁªèÂ∏∏ÁÖßÈ°æ‰∏ªËßíÔºå‰ΩÜ‰πüÊãÖÂøÉÈöèÁùÄÈïøÂ§ßÂΩºÊ≠§‰ºöÊ∏êË°åÊ∏êËøú„ÄÇ"
                },
                "teacher": {
                    name: "Á•ûÂ¥éËÄÅÂ∏à",
                    persona: "Êñ∞Êù•ÁöÑÂπ¥ËΩªÁæéÊúØËÄÅÂ∏àÔºåÁ•ûÁßò‰∏îÂÖÖÊª°È≠ÖÂäõÔºåËÉåÊôØ‰∏ç‰∏∫‰∫∫Áü•„ÄÇÊúâÁùÄÁ¥´Ëâ≤ÈïøÂèëÂíåÊ∏©ÊüîÁöÑÂæÆÁ¨ëÔºå‰ΩÜÁúºÁ•û‰∏≠ËóèÁùÄÁßòÂØÜ„ÄÇÂØπÂ≠¶ÁîüÂèãÂñÑ‰ΩÜ‰øùÊåÅË∑ùÁ¶ªÔºå‰ºº‰πéÊúâ‰∏ç‰∏∫‰∫∫Áü•ÁöÑËøáÂéª„ÄÇ"
                },
                "alien": {
                    name: "ÊòüÁíÉ",
                    persona: "Á™ÅÁÑ∂Âá∫Áé∞ÁöÑËΩ¨Â≠¶ÁîüÔºåÂÆûÈôÖÊòØÊù•Ëá™ÂºÇ‰∏ñÁïå/Â§ñÊòüÁêÉÁöÑËÆøÂÆ¢„ÄÇÊúâÁùÄÈì∂ÁôΩËâ≤ÁöÑÈïøÂèëÂíåÁ¥´Ëâ≤ÁöÑÁúºÁùõÔºåÂØπ‰∫∫Á±ª‰∏ñÁïåÁöÑÂ∏∏ËØÜÊÑüÂà∞Âõ∞ÊÉë„ÄÇÊã•ÊúâË∂ÖÂ∏∏ÁöÑËÉΩÂäõÔºåÊù•Âà∞ËøôÈáå‰ºº‰πéÊúâÁùÄÁâπÊÆäÁöÑ‰ΩøÂëΩ„ÄÇ"
                }
            };

            // ÊïÖ‰∫ã‰∏ªÈ¢òÂêçÁß∞Áî®‰∫éÊèêÁ§∫
            const storyThemeNames = {
                "romance": "ÊÅãÁà±",
                "mystery": "ÊÇ¨ÁñëÊé®ÁêÜ",
                "fantasy": "Â•áÂπªÂÜíÈô©",
                "school": "Ê†°Âõ≠Êó•Â∏∏",
                "scifi": "ÁßëÂπªÊú™Êù•"
            };

            // --- Áä∂ÊÄÅÂèòÈáè ---
            // API & AI
            let currentApiKey = '';
            let currentApiUrl = '';
            let currentModel = '';
            let currentAiPersona = '';
            // Áé©ÂÆ∂
            let playerName = '';
            let playerPersona = '';
            let playerStart = '';
            // ÂõæÁâáÊï∞ÊçÆ(Base64Â≠óÁ¨¶‰∏≤) - ‰∏ç‰øùÂ≠òÂú®localStorage
            let playerImageBase64 = null;
            let aiImageBase64 = null;
            // ËßíËâ≤Â§ñËßÇ
            let playerBaseAppearancePrompt = '';
            let aiBaseAppearancePrompt = '';
            let spriteCache = {};
            // Ê∏∏ÊàèÁä∂ÊÄÅ
            let conversationHistory = [];
            let isGameStarted = false;
            let isLoading = false;
            let currentDialogueSegments = [];
            let currentSegmentIndex = 0;
            let currentTurnChoices = [];
            let currentTurnParsedData = null;

            // --- ÊïÖ‰∫ãË∑üË∏™Âô®ÂØπË±° ---
            const StoryTracker = {
                // ÊïÖ‰∫ãÂÖÉÊï∞ÊçÆ
                metadata: {
                    currentAct: 1,
                    totalActs: 3,
                    progress: 0, // 0-100
                    branchPath: "main",
                    availableEndings: [], // Áî±AIÂú®È¶ñ‰∏™ÂìçÂ∫î‰∏≠Â°´ÂÖÖ
                    currentEnding: null,
                    remainingTurns: 15
                },

                // ÂàùÂßãÂåñÊïÖ‰∫ãË∑üË∏™Âô®
                initialize(storyTheme, storyLength, complexity) {
                    this.metadata = {
                        currentAct: 1,
                        totalActs: storyLength === "short" ? 2 : (storyLength === "medium" ? 3 : 4),
                        progress: 0,
                        branchPath: "main",
                        availableEndings: [],
                        currentEnding: null,
                        remainingTurns: storyLength === "short" ? 10 : (storyLength === "medium" ? 15 : 20)
                    };

                    return {
                        story_metadata: this.metadata,
                        story_theme: storyTheme,
                        complexity: complexity,
                        request_type: "initialize_story"
                    };
                },

                // ‰ªéAIÂìçÂ∫îÊõ¥Êñ∞
                updateFromAIResponse(response) {
                    if (response && response.story_metadata) {
                        this.metadata = { ...this.metadata, ...response.story_metadata };
                        this.updateProgressUI();
                    }

                    // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÊïÖ‰∫ãÁªìÂ±Ä
                    if (this.metadata.progress >= 100 || this.metadata.currentEnding) {
                        setTimeout(() => {
                            displayStoryEnding(this.metadata.currentEnding || {
                                type: "neutral",
                                name: "ÊïÖ‰∫ãÁªìÊùü",
                                description: "‰Ω†ÁöÑÊïÖ‰∫ãÂ∑≤ÁªèÁªìÊùü„ÄÇË∞¢Ë∞¢Ê∏∏Áé©ÔºÅ"
                            });
                        }, 2000);
                    }
                },

                // Êõ¥Êñ∞ËøõÂ∫¶UI
                updateProgressUI() {
                    storyProgressBar.style.display = 'block';
                    const progressInner = storyProgressBar.querySelector('.progress-inner');
                    const progressText = storyProgressBar.querySelector('.progress-text');

                    progressInner.style.width = `${this.metadata.progress}%`;
                    progressText.textContent = `ÊïÖ‰∫ãËøõÂ∫¶: ${this.metadata.progress}% | Á¨¨${this.metadata.currentAct}Âπï | Ââ©‰ΩôÂõûÂêà: ${this.metadata.remainingTurns}`;
                },

                // ÈáçÁΩÆË∑üË∏™Âô®
                reset() {
                    this.metadata = {
                        currentAct: 1,
                        totalActs: 3,
                        progress: 0,
                        branchPath: "main",
                        availableEndings: [],
                        currentEnding: null,
                        remainingTurns: 15
                    };
                    storyProgressBar.style.display = 'none';
                }
            };

            // --- ËæÖÂä©ÂáΩÊï∞ ---
            // Èò≤ÊäñÂáΩÊï∞Áî®‰∫éËæìÂÖ•ÂèòÊõ¥
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // ‰ªéÊï∞ÊçÆURL‰∏≠ÊèêÂèñMIMEÁ±ªÂûãÂíåbase64Êï∞ÊçÆ
            function getImageDataFromBase64(base64String) {
                if (!base64String || !base64String.startsWith('data:image')) {
                    return null;
                }
                const parts = base64String.split(',');
                if (parts.length !== 2) return null;
                const mimeMatch = parts[0].match(/:(.*?);/);
                if (!mimeMatch || mimeMatch.length < 2) return null;
                return {
                    mimeType: mimeMatch[1],
                    data: parts[1]
                };
            }

            // ÂõæÁâáÂéãÁº©ÂáΩÊï∞
            async function compressImage(base64String, maxWidthHeight = 800, quality = 0.8) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // ËÆ°ÁÆóÊñ∞Â∞∫ÂØ∏Ôºå‰øùÊåÅÂÆΩÈ´òÊØî
                        let width = img.width;
                        let height = img.height;
                        if (width > height && width > maxWidthHeight) {
                            height = height * (maxWidthHeight / width);
                            height = height * (maxWidthHeight / width);
                            width = maxWidthHeight;
                        } else if (height > maxWidthHeight) {
                            width = width * (maxWidthHeight / height);
                            height = maxWidthHeight;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // ÁªòÂà∂ÂéãÁº©ÂõæÂÉè
                        ctx.drawImage(img, 0, 0, width, height);

                        // ËΩ¨Êç¢ÂõûBase64
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = base64String;
                });
            }

            // --- ËßíËâ≤SpriteËÉåÊôØÂéªÈô§ ---
            async function removeEdgeWhiteBackground(img) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    const width = img.naturalWidth; const height = img.naturalHeight;
                    if (width === 0 || height === 0) { console.warn("ÂõæÂÉèÂ∞∫ÂØ∏‰∏∫Èõ∂ÔºåÊó†Ê≥ïÂ§ÑÁêÜ„ÄÇ"); resolve(img.src); return; }
                    canvas.width = width; canvas.height = height;
                    try {
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const data = imageData.data;
                        const visited = new Uint8Array(width * height);

                        // --- Á¨¨‰∏ÄÊ¨°Â§ÑÁêÜ: Edge Flood Fill (‰ΩøÁî®ÈÄÇ‰∏≠ÁöÑÂÆπÂ∑ÆÂÄº) ---
                        const whiteThreshold = 255;
                        const floodFillTolerance = 7; // <<<<<<<<<< ÂèØÂ∞ùËØïË∞ÉÊï¥Ê≠§ÂÄº (4, 5 Êàñ 6)
                        const effectiveFloodThreshold = whiteThreshold - floodFillTolerance;

                        function isNearWhiteForFlood(index) {
                            if (index < 0 || index >= data.length || data[index + 3] < 128) return false;
                            const r = data[index]; const g = data[index + 1]; const b = data[index + 2];
                            return r >= effectiveFloodThreshold && g >= effectiveFloodThreshold && b >= effectiveFloodThreshold;
                        }
                        function getIndex(x, y) { return (y * width + x) * 4; }
                        function getVisitedIndex(x, y) { return y * width + x; }
                        const queue = [];
                        for (let y = 0; y < height; y++) {
                            for (let x = 0; x < width; x++) {
                                if (y === 0 || y === height - 1 || x === 0 || x === width - 1) {
                                    const index = getIndex(x, y);
                                    const visitedIndex = getVisitedIndex(x, y);
                                    if (!visited[visitedIndex] && isNearWhiteForFlood(index)) {
                                        queue.push({ x, y });
                                        visited[visitedIndex] = 1;
                                    }
                                }
                            }
                        }
                        console.log(`ÂºÄÂßãFlood FillÂ§ÑÁêÜ„ÄÇÂÆπÂ∑ÆÂÄº: ${floodFillTolerance}. ÂàùÂßãÈòüÂàó:`, queue.length);
                        let processedFloodFillCount = 0;
                        while (queue.length > 0) {
                            const { x, y } = queue.shift(); const index = getIndex(x, y);
                            if (data[index + 3] > 0) { data[index + 3] = 0; processedFloodFillCount++; } // ËÆæ‰∏∫ÈÄèÊòé
                            const neighbors = [{ nx: x + 1, ny: y }, { nx: x - 1, ny: y }, { nx: x, ny: y + 1 }, { nx: x, ny: y - 1 }];
                            for (const { nx, ny } of neighbors) {
                                if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                    const neighborIndex = getIndex(nx, ny);
                                    const visitedIndex = getVisitedIndex(nx, ny);
                                    if (!visited[visitedIndex] && isNearWhiteForFlood(neighborIndex)) {
                                        queue.push({ x: nx, y: ny });
                                        visited[visitedIndex] = 1;
                                    }
                                }
                            }
                        }
                        console.log(`Flood fillÂÆåÊàê„ÄÇ${processedFloodFillCount}‰∏™ÂÉèÁ¥†ËÆæ‰∏∫ÈÄèÊòé„ÄÇ`);

                        // --- Á¨¨‰∫åÊ¨°Â§ÑÁêÜ: Ê∏ÖÁêÜÂ≠§Á´ãÁöÑÁôΩËâ≤ÂÉèÁ¥†ÁÇπ ---
                        const cleanupTolerance = 4; // <<<<<<<<<< ‰ΩøÁî®‰∏•Ê†ºÁöÑÂÆπÂ∑ÆÂÄº
                        const effectiveCleanupThreshold = whiteThreshold - cleanupTolerance;
                        let cleanedPixelCount = 0;

                        console.log(`ÂºÄÂßãÊ∏ÖÁêÜÂ≠§Á´ãÂÉèÁ¥†„ÄÇ‰∏•Ê†ºÂÆπÂ∑Æ: ${cleanupTolerance}`);
                        for (let y = 1; y < height - 1; y++) { // Ë∑≥ËøáËæπÁïå
                            for (let x = 1; x < width - 1; x++) {
                                const index = getIndex(x, y);
                                // Ê£ÄÊü•ÂÉèÁ¥†ÊòØÂê¶Â∑≤ÁªèÈÄèÊòé
                                if (data[index + 3] > 0) {
                                    const r = data[index]; const g = data[index + 1]; const b = data[index + 2];
                                    // Ê£ÄÊü•ÊòØÂê¶ÈùûÂ∏∏Êé•ËøëÁôΩËâ≤
                                    if (r >= effectiveCleanupThreshold && g >= effectiveCleanupThreshold && b >= effectiveCleanupThreshold) {
                                        // Ê£ÄÊü•ÂÖ∂Âë®Âõ¥4‰∏™Áõ¥Êé•Áõ∏ÈÇªÂÉèÁ¥†
                                        let transparentNeighbors = 0;
                                        const neighborsIndices = [getIndex(x + 1, y), getIndex(x - 1, y), getIndex(x, y + 1), getIndex(x, y - 1)];
                                        for (const nIndex of neighborsIndices) {
                                            // Ê£ÄÊü•ÈÇªÂ±ÖÊòØÂê¶Âú®ËæπÁïåÂÜÖ‰∏îÈÄèÊòé
                                            if (nIndex >= 0 && nIndex < data.length && data[nIndex + 3] === 0) {
                                                transparentNeighbors++;
                                            }
                                        }
                                        // Â¶ÇÊûú4‰∏™ÈÇªÂ±Ö‰∏≠Êúâ3‰∏™Êàñ‰ª•‰∏äÊòØÈÄèÊòéÁöÑÔºåËÆ§‰∏∫ÊòØÂ≠§Á´ãÁÇπ
                                        if (transparentNeighbors >= 3) {
                                            data[index + 3] = 0; // Â∞ÜÂÖ∂ËÆæ‰∏∫ÈÄèÊòé
                                            cleanedPixelCount++;
                                        }
                                    }
                                }
                            }
                        }
                        console.log(`Â≠§Á´ãÂÉèÁ¥†Ê∏ÖÁêÜÂÆåÊàê„ÄÇ${cleanedPixelCount}‰∏™Â≠§Á´ãÂÉèÁ¥†Ë¢´ËÆæ‰∏∫ÈÄèÊòé„ÄÇ`);

                        ctx.putImageData(imageData, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    } catch (error) {
                        // ÈîôËØØÂ§ÑÁêÜ
                        if (error.name === 'SecurityError') {
                            console.error("CanvasÂ§ÑÁêÜÈîôËØØ(ÂèØËÉΩÊòØCORSÈóÆÈ¢ò)...", error);
                            resolve(img.src);
                        } else {
                            console.error("removeEdgeWhiteBackground‰∏≠CanvasÂ§ÑÁêÜÈîôËØØ:", error);
                            resolve(img.src);
                        }
                    }
                });
            }

            // --- ÂõæÂÉèÂä†ËΩΩ ---
            async function loadDynamicImage(element, prompt, imageType = "background", nologo = true, seed = null) {
                if (!prompt || !element) {
                    console.warn(`Ë∑≥Ëøá${imageType}ÂõæÂÉè: Ê≤°ÊúâÊèê‰æõÊèêÁ§∫ÊàñÂÖÉÁ¥†„ÄÇ`);
                    if (imageType === 'character') {
                        element.classList.add('hidden');
                        element.style.opacity = null;
                    }
                    return Promise.resolve();
                }

                const baseCharacterPrompt = prompt;
                console.log(`Â∞ùËØïÂä†ËΩΩ${imageType}ÂõæÂÉèÔºåÂü∫Á°ÄÊèêÁ§∫: ${baseCharacterPrompt}`);

                let width = 768, height = 1024, extraParams = "", finalPromptString;

                if (imageType === 'character') {
                    width = 768; height = 1024; extraParams = "&nofeed=true";
                    finalPromptString = `${FIXED_STYLE_PROMPT}, ${SPRITE_BACKGROUND_KEYWORDS}, ${baseCharacterPrompt}`;
                    console.log("ÊúÄÁªàËßíËâ≤ÊèêÁ§∫:", finalPromptString);

                    if (spriteCache[finalPromptString]) {
                        console.log(`ÁºìÂ≠òÂëΩ‰∏≠: ${finalPromptString.substring(0, 100)}...`);
                        element.src = spriteCache[finalPromptString];
                        element.classList.remove('hidden');
                        element.style.opacity = null; // Ê∏ÖÈô§ÂÜÖËÅîÊ†∑Âºè
                        return Promise.resolve();
                    }

                    element.classList.add('hidden');
                    element.style.opacity = null; // Ê∑ªÂä†hiddenÊó∂Ê∏ÖÈô§ÂÜÖËÅîÊ†∑Âºè
                } else if (imageType === 'background') {
                    finalPromptString = `${baseCharacterPrompt}, anime style, visual novel background, detailed illustration, high quality`;
                    width = 1024;
                    height = 576;
                    extraParams = "&nofeed=true";
                }

                const nologoValue = nologo ? 'true' : 'false';
                let url = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPromptString)}?width=${width}&height=${height}&model=flux&nologo=${nologoValue}${extraParams}`;

                if (seed) {
                    url += `&seed=${encodeURIComponent(seed)}`;
                }

                console.log(`ÁîüÊàê${imageType}ÂõæÂÉèURL:`, url);

                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";

                    img.onload = async () => {
                        console.log(`${imageType}ÂõæÂÉèÈ¢ÑÂä†ËΩΩÊàêÂäü„ÄÇ`);
                        if (imageType === 'background') {
                            element.style.backgroundImage = `url('${url}')`;
                            console.log(`ËÉåÊôØÂõæÂÉèÂ∑≤ËÆæÁΩÆ:`, element);
                            resolve();
                        } else { // Â§ÑÁêÜËßíËâ≤ÂõæÂÉè
                            try {
                                console.log(`Â∞ùËØïÁßªÈô§${element.id}ÁöÑÁôΩËâ≤ËÉåÊôØ...`);
                                const processedUrl = await removeEdgeWhiteBackground(img);
                                element.src = processedUrl;
                                spriteCache[finalPromptString] = processedUrl; // ÁºìÂ≠òÂ§ÑÁêÜÂêéÁöÑURL
                                element.classList.remove('hidden');
                                element.style.opacity = null; // ÊàêÂäüÂêéÊ∏ÖÈô§ÂÜÖËÅîÊ†∑Âºè
                                console.log(`${element.id}ÁöÑÁôΩËâ≤ËÉåÊôØÂ∑≤ÁßªÈô§„ÄÇ`);
                            } catch (error) {
                                console.error(`${element.id}ËÉåÊôØÁßªÈô§ÈîôËØØ:`, error);
                                element.src = url; // ÂõûÈÄÄ‰ΩøÁî®ÂéüÂßãURL
                                spriteCache[finalPromptString] = url; // ÁºìÂ≠òÂéüÂßãURL
                                element.classList.remove('hidden');
                                element.style.opacity = null; // ÂõûÈÄÄÊó∂Ê∏ÖÈô§ÂÜÖËÅîÊ†∑Âºè
                                showGameError(`Â§ÑÁêÜ${element.alt}ËÉåÊôØÊó∂Âá∫Èîô„ÄÇ`);
                            } finally {
                                resolve();
                            }
                        }
                    };

                    img.onerror = (e) => {
                        console.error(`Âä†ËΩΩ${imageType}ÂõæÂÉèÈîôËØØ:`, e, url);
                        showGameError(`${imageType === 'character' ? element.alt : 'ËÉåÊôØ'}Âä†ËΩΩÂ§±Ë¥•„ÄÇ`);
                        if (imageType === 'character') {
                            element.classList.add('hidden');
                            element.style.opacity = null; // ÈîôËØØÊó∂Ê∏ÖÈô§ÂÜÖËÅîÊ†∑Âºè
                        }
                        resolve();
                    };

                    img.src = url;
                });
            }

            // ËØªÂèñÊñá‰ª∂ËæìÂÖ•Âπ∂ËΩ¨Êç¢‰∏∫Base64
            function handleImageUpload(fileInput, previewElement, clearButton, stateVariableSetter) {
                const file = fileInput.files[0];
                if (!file) {
                    stateVariableSetter(null);
                    previewElement.style.display = 'none';
                    clearButton.style.display = 'none';
                    return;
                }

                if (!ALLOWED_IMAGE_TYPES.includes(file.type)) {
                    showGameError(`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã: ${file.type}. ËØ∑‰∏ä‰º† JPG, PNG, Êàñ WebP Ê†ºÂºèÂõæÁâá.`);
                    fileInput.value = null;
                    stateVariableSetter(null);
                    previewElement.style.display = 'none';
                    clearButton.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const result = e.target.result;
                    // ÂéãÁº©ÂõæÁâá‰ª•ÂáèÂ∞ëAPIË∞ÉÁî®Â§ßÂ∞è
                    const compressedImage = await compressImage(result);
                    stateVariableSetter(compressedImage);
                    previewElement.src = compressedImage;
                    previewElement.style.display = 'block';
                    clearButton.style.display = 'inline-block';
                    console.log(`ÂõæÁâáÂ∑≤Âä†ËΩΩÂπ∂ÂéãÁº©: ${fileInput.id}`);
                };
                reader.onerror = (e) => {
                    showGameError("ËØªÂèñÂõæÁâáÊñá‰ª∂Êó∂Âá∫Èîô.");
                    console.error("FileReader error:", e);
                    fileInput.value = null;
                    stateVariableSetter(null);
                    previewElement.style.display = 'none';
                    clearButton.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            // Ê∏ÖÈô§ÂõæÁâá‰∏ä‰º†
            function clearImageUpload(fileInput, previewElement, clearButton, stateVariableSetter) {
                fileInput.value = null;
                stateVariableSetter(null);
                previewElement.src = '#';
                previewElement.style.display = 'none';
                clearButton.style.display = 'none';
                console.log(`Â∑≤Ê∏ÖÈô§ÂõæÁâá: ${fileInput.id}`);
            }

            // ÂÆâÂÖ®APIÂØÜÈí•Â≠òÂÇ®
            function secureStoreApiKey(key) {
                // ÁÆÄÂçïÊ∑∑Ê∑ÜÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠Â∫îËÄÉËôëÊõ¥ÂÆâÂÖ®ÁöÑÊñπÂºè
                const obscuredKey = btoa(key.split('').reverse().join(''));
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'apiKeyObscured', obscuredKey);
            }

            function secureRetrieveApiKey() {
                const obscuredKey = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'apiKeyObscured');
                if (!obscuredKey) return '';
                return atob(obscuredKey).split('').reverse().join('');
            }

            // ÊòæÁ§∫Á´†ËäÇÊ†áËÆ∞
            function renderChapterMarker(chapterInfo) {
                const chapterMarker = document.createElement('div');
                chapterMarker.className = 'chapter-marker';
                chapterMarker.innerHTML = `
                <div class="chapter-line"></div>
                <div class="chapter-title">${chapterInfo.title}</div>
                <div class="chapter-line"></div>
            `;
                dialogueBox.insertBefore(chapterMarker, choicesContainer);

                // ÊªöÂä®Âà∞Á´†ËäÇÊ†áËÆ∞
                setTimeout(() => {
                    chapterMarker.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }

            // ÊòæÁ§∫ÈÄâÊã©ÂΩ±Âìç
            function showChoiceImpact(impactType) {
                const impactMessage = document.createElement('div');
                impactMessage.className = `choice-impact ${impactType}`;

                let message = "";
                let icon = "";

                switch (impactType) {
                    case 'relationship-up':
                        message = "Â•ΩÊÑüÂ∫¶ÊèêÂçá";
                        icon = "‚ù§Ô∏è";
                        break;
                    case 'relationship-down':
                        message = "Â•ΩÊÑüÂ∫¶‰∏ãÈôç";
                        icon = "üíî";
                        break;
                    case 'story-branch':
                        message = "ÊïÖ‰∫ãËµ∞ÂêëÊîπÂèò";
                        icon = "üîÄ";
                        break;
                    case 'progress-significant':
                        message = "ÈáçË¶ÅÂâßÊÉÖÁÇπ";
                        icon = "‚ú®";
                        break;
                }

                impactMessage.innerHTML = `${icon} ${message}`;
                document.getElementById('galgame-container').appendChild(impactMessage);

                // Âä®ÁîªÂêéÁßªÈô§
                setTimeout(() => {
                    impactMessage.classList.add('fadeout');
                    setTimeout(() => impactMessage.remove(), 1000);
                }, 2000);
            }

            // ÊòæÁ§∫ÊïÖ‰∫ãÁªìÂ±Ä
            function displayStoryEnding(ending) {
                // ÂàõÂª∫ÁªìÂ±ÄÊòæÁ§∫Èù¢Êùø
                const endingPanel = document.createElement('div');
                endingPanel.className = 'story-ending-panel';

                // ÁªìÂ±ÄÊ†áÈ¢òÂíåÁ±ªÂûã
                const endingTitle = ending.type === "good" ? "ÂÆåÁæéÁªìÂ±Ä" :
                    (ending.type === "neutral" ? "ÊôÆÈÄöÁªìÂ±Ä" : "Á≥üÁ≥ïÁªìÂ±Ä");

                endingPanel.innerHTML = `
                <div class="ending-header">
                    <h2>${endingTitle}</h2>
                    <div class="ending-type ${ending.type}">${ending.name || 'ÊïÖ‰∫ãÁªìÊùü'}</div>
                </div>
                <div class="ending-content">${ending.description || '‰Ω†ÁöÑÊïÖ‰∫ãÂ∑≤ÁªèÁªìÊùü„ÄÇ'}</div>
                <div class="ending-buttons">
                    <button class="restart-button">ÈáçÊñ∞ÂºÄÂßã</button>
                    <button class="share-button">ÂàÜ‰∫´ÁªìÂ±Ä</button>
                </div>
            `;

                // Ê∑ªÂä†Âà∞Ê∏∏ÊàèÂÆπÂô®
                document.getElementById('galgame-container').appendChild(endingPanel);

                // ‰∫ã‰ª∂ÁõëÂê¨
                endingPanel.querySelector('.restart-button').addEventListener('click', restartGame);
                endingPanel.querySelector('.share-button').addEventListener('click', () => {
                    // ÂàÜ‰∫´ÂäüËÉΩ
                    alert('ÂàÜ‰∫´ÂäüËÉΩÂç≥Â∞ÜÊé®Âá∫ÔºÅ');
                });
            }

            // ÈáçÂêØÊ∏∏Êàè
            function restartGame() {
                // Ê∏ÖÈô§Áä∂ÊÄÅ
                conversationHistory = [];
                currentDialogueSegments = [];
                currentSegmentIndex = 0;
                currentTurnChoices = [];
                currentTurnParsedData = null;
                isGameStarted = false;

                // ÈáçÁΩÆËøõÂ∫¶Êù°
                StoryTracker.reset();

                // ÈáçÁΩÆUI
                dialogueText.innerHTML = 'Âú®ËøôÈáåËÆæÁΩÆÁé©ÂÆ∂ÂêçÁß∞„ÄÅËÆæÂÆöÂíåÊúüÊúõÂºÄÂ±ÄÂêéÔºåÁÇπÂáª"ÂºÄÂßã"„ÄÇ';
                speakerName.textContent = 'ÊóÅÁôΩ';
                choicesContainer.innerHTML = '';
                aiCharacterSprite.classList.add('hidden');
                playerCharacterSprite.classList.add('hidden');

                // ÁßªÈô§ÁªìÂ±ÄÈù¢Êùø
                const endingPanel = document.querySelector('.story-ending-panel');
                if (endingPanel) endingPanel.remove();

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                nextButton.textContent = 'ÂºÄÂßã';

                // ÊâìÂºÄËÆæÁΩÆÈù¢Êùø
                configPanel.classList.add('visible');
            }

            // --- ÈîôËØØÂíåÂä†ËΩΩUI ---
            function showGameError(message) {
                console.error("Ê∏∏ÊàèÈîôËØØ:", message);
                gameErrorMessage.textContent = message;
                gameErrorMessage.style.display = 'block';
                setTimeout(() => {
                    clearGameError();
                }, 5000);
            }

            function clearGameError() {
                gameErrorMessage.style.display = 'none';
                gameErrorMessage.textContent = '';
            }

            function setLoading(loading) {
                console.log("ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ‰∏∫:", loading);
                isLoading = loading;
                loadingOverlay.classList.toggle('visible', loading);
                const canInteract = currentApiKey && currentModel;
                const choicesCurrentlyDisplayed = choicesContainer.querySelector('.choice-button') !== null;
                const moreSegmentsAvailable = currentDialogueSegments && currentSegmentIndex < currentDialogueSegments.length - 1;
                nextButton.disabled = loading || !canInteract || !isGameStarted || choicesCurrentlyDisplayed || !moreSegmentsAvailable;
                toggleHistoryBtn.disabled = loading || !canInteract || !isGameStarted;
                // ÁßªÈô§Ëøô‰∏ÄË°å: toggleConfigBtn.disabled = loading;
                document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = loading);
            }

            // --- ÈÖçÁΩÆÈÄªËæë ---
            function saveConfig() {
                // ÊñáÊú¨ÈÖçÁΩÆ‰øùÂ≠òÂà∞localStorage
                const apiKey = apiKeyInput.value.trim();
                const apiUrl = apiUrlInput.value.trim() || DEFAULT_API_URL_GALGAME;
                const model = modelSelect.value;
                const aiPersona = aiPersonaInput.value.trim();
                const pName = playerNameInput.value.trim();
                const pPersona = playerPersonaInput.value.trim();
                const pStart = playerStartInput.value.trim();

                // ÂÆâÂÖ®Â≠òÂÇ®APIÂØÜÈí•
                secureStoreApiKey(apiKey);

                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'apiUrl', apiUrl);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'model', model);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'aiPersona', aiPersona);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'playerName', pName);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'playerPersona', pPersona);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'playerStart', pStart);

                // ÊïÖ‰∫ãËÆæÁΩÆ
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'storyTheme', storyThemeSelect.value);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'storyLength', storyLengthSelect.value);
                localStorage.setItem(GALGAME_STORAGE_PREFIX + 'storyComplexity', storyComplexityRange.value);

                // Êõ¥Êñ∞ÂΩìÂâçÂèòÈáè
                currentApiKey = apiKey;
                currentApiUrl = apiUrl;
                currentModel = model;
                currentAiPersona = aiPersona;
                playerName = pName;
                playerPersona = pPersona;
                playerStart = pStart;

                console.log("Ê∏∏ÊàèÈÖçÁΩÆÂ∑≤‰øùÂ≠ò:", { currentApiKey: "Â∑≤ÈöêËóè", currentApiUrl, currentModel, currentAiPersona, playerName, playerPersona, playerStart });

                const canEnable = currentApiKey && currentModel;
                nextButton.disabled = !canEnable;
                nextButton.textContent = canEnable ? 'ÂºÄÂßã' : 'ÂºÄÂßã (ËØ∑ÂÖàËÆæÁΩÆAPI)';

                showGameError("ËÆæÁΩÆÂ∑≤‰øùÂ≠ò.");
            }

            function loadConfig() {
                // ‰ªélocalStorageÂä†ËΩΩÊñáÊú¨ÈÖçÁΩÆ
                currentApiKey = secureRetrieveApiKey() || '';
                currentApiUrl = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'apiUrl') || DEFAULT_API_URL_GALGAME;
                currentModel = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'model') || '';
                currentAiPersona = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'aiPersona') || '';
                playerName = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'playerName') || '';
                playerPersona = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'playerPersona') || '';
                playerStart = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'playerStart') || '';

                // Âä†ËΩΩÊïÖ‰∫ãËÆæÁΩÆ
                const savedTheme = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'storyTheme');
                const savedLength = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'storyLength');
                const savedComplexity = localStorage.getItem(GALGAME_STORAGE_PREFIX + 'storyComplexity');

                if (savedTheme) storyThemeSelect.value = savedTheme;
                if (savedLength) storyLengthSelect.value = savedLength;
                if (savedComplexity) storyComplexityRange.value = savedComplexity;

                // ÈáçÁΩÆÂõæÁâá‰∏ä‰º†
                clearImageUpload(playerImageUpload, playerImagePreview, clearPlayerImageBtn, (val) => playerImageBase64 = val);
                clearImageUpload(aiImageUpload, aiImagePreview, clearAiImageBtn, (val) => aiImageBase64 = val);

                console.log("Ê∏∏ÊàèÈÖçÁΩÆÂ∑≤Âä†ËΩΩ (ÂõæÁâáÂ∑≤ÈáçÁΩÆ):", { currentApiKey: "Â∑≤ÈöêËóè", currentApiUrl, currentModel, currentAiPersona, playerName, playerPersona, playerStart });

                const canConfigure = currentApiKey && currentModel;

                // Êõ¥Êñ∞UIÂèçÊò†ÈÖçÁΩÆ
                apiKeyInput.value = currentApiKey;
                apiUrlInput.value = currentApiUrl;

                if (currentModel) {
                    // Â¶ÇÊûúÂ∑≤Êúâ‰øùÂ≠òÁöÑÊ®°ÂûãÔºåÁ°Æ‰øùÊ®°ÂûãÈÄâÊã©Âô®‰∏≠ÊúâËØ•ÈÄâÈ°π
                    if (modelSelect.querySelector(`option[value="${currentModel}"]`)) {
                        modelSelect.value = currentModel;
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÔºåÂàõÂª∫‰∏Ä‰∏™
                        const option = document.createElement('option');
                        option.value = currentModel;
                        option.textContent = currentModel;
                        modelSelect.appendChild(option);
                        modelSelect.value = currentModel;
                        modelSelect.disabled = false;
                    }
                }

                aiPersonaInput.value = currentAiPersona;
                playerNameInput.value = playerName;
                playerPersonaInput.value = playerPersona;
                playerStartInput.value = playerStart;

                nextButton.disabled = !canConfigure;
                nextButton.textContent = canConfigure ? 'ÂºÄÂßã' : 'ÂºÄÂßã (ËØ∑ÂÖàËÆæÁΩÆAPI)';
            }

            function toggleConfigPanel() {
                configPanel.classList.toggle('visible');
            }

            // --- ÂàùÂßãÂåñÊïÖ‰∫ã ---
            async function initializeGame() {
                // Êî∂ÈõÜÊïÖ‰∫ãËÆæÁΩÆ
                const storyTheme = storyThemeSelect.value;
                const storyLength = storyLengthSelect.value;
                const storyComplexity = storyComplexityRange.value;

                // ÂàùÂßãÂåñÊïÖ‰∫ãË∑üË∏™Âô®
                const storyMetadata = StoryTracker.initialize(storyTheme, storyLength, storyComplexity);

                // ÊûÑÂª∫ÂàùÂßãÂåñËØ∑Ê±Ç
                const initPrompt = `ËØ∑‰∏∫ÊàëÂàõÂª∫‰∏Ä‰∏™${storyThemeNames[storyTheme]}Á±ªÂûãÁöÑËßÜËßâÂ∞èËØ¥ÊïÖ‰∫ã„ÄÇ
Áé©ÂÆ∂ËßíËâ≤ÊòØÔºö${playerName || '‰∏ªËßí'}Ôºå${playerPersona || '‰∏ÄÂêçÊôÆÈÄöÁöÑÈ´ò‰∏≠Áîü'}
AIËßíËâ≤ÊòØÔºö${currentAiPersona || 'Áî±‰Ω†ÂÜ≥ÂÆö‰∏Ä‰∏™ÊúâË∂£ÁöÑËßíËâ≤'}

„ÄêÈáçË¶ÅÔºÅÊïÖ‰∫ãËßÑÂàíË¶ÅÊ±Ç„ÄëÔºö
Âú®‰Ω†ÁöÑÂìçÂ∫î‰∏≠ÔºåËØ∑ÂÖàÂÜÖÈÉ®ÂàõÂª∫‰ª•‰∏ãÂÜÖÂÆπÔºà‰∏çË¶ÅÁõ¥Êé•Â±ïÁ§∫ÁªôÁé©ÂÆ∂ÔºâÔºö
1. ÊïÖ‰∫ã‰∏ªÁ∫øÔºöËÆæËÆ°3-5‰∏™ÂÖ≥ÈîÆÊÉÖËäÇÁÇπ
2. ÂèØËÉΩÁöÑÁªìÂ±ÄÔºöËá≥Â∞ëËÆæËÆ°3‰∏™‰∏çÂêåÁªìÂ±ÄÔºàÂ•Ω/‰∏≠Á´ã/ÂùèÔºâ
3. ÂàÜÊîØÊù°‰ª∂ÔºöÁ°ÆÂÆöÂì™‰∫õÁé©ÂÆ∂ÈÄâÊã©‰ºöÂØºÂêë‰∏çÂêåÂàÜÊîØ
4. ËøõÂ∫¶ÊåáÁ§∫Âô®ÔºöÊØèÊ¨°ÂõûÂ∫îÈÉΩË¶ÅÊèê‰æõstory_metadataÂ≠óÊÆµÊõ¥Êñ∞ËøõÂ∫¶Ôºà0%~100%Ôºâ

ÊïÖ‰∫ãÂ∫îËØ•ÂåÖÂê´ÊòéÁ°ÆÁöÑÂºÄÂßã„ÄÅ‰∏≠Èó¥ÂÜ≤Á™ÅÂíåÁªìÂ±Ä„ÄÇ
Â§çÊùÇÂ∫¶Ë¶ÅÊ±ÇÔºö${storyComplexity}/5ÔºàË∂äÈ´òÂàÜÊîØÈÄâÊã©Ë∂äÂ§öÔºâ
ÊúüÊúõÈïøÂ∫¶Ôºö${storyLength === 'short' ? 'Áü≠ÁØáÔºàÁ∫¶10ÂõûÂêàÔºâ' : (storyLength === 'medium' ? '‰∏≠ÁØáÔºàÁ∫¶15ÂõûÂêàÔºâ' : 'ÈïøÁØáÔºàÁ∫¶20ÂõûÂêàÔºâ')}
ÂºÄÂú∫ÊÉÖÊôØÔºö${playerStart || 'Áî±‰Ω†ÂÜ≥ÂÆöÈÄÇÂêàÁöÑÂºÄÂú∫'}

ËØ∑Âú®ÂõûÂ∫î‰∏≠ÂåÖÂê´Ôºö
1. ÂÜÖÈÉ®ÊïÖ‰∫ãÂ§ßÁ∫≤Ôºà‰∏çÁõ¥Êé•Â±ïÁ§∫ÁªôÁé©ÂÆ∂Ôºâ
2. ÂèØËÉΩÁöÑÁªìÂ±ÄÂàÜÊîØ
3. Á¨¨‰∏Ä‰∏™Âú∫ÊôØÊèèËø∞ÂíåÂØπËØù

ÂΩìÊïÖ‰∫ãËøõË°åÂà∞70%‰ª•‰∏äÊó∂ÔºåÂºÄÂßãÂºïÂØºÁé©ÂÆ∂Ëµ∞ÂêëÊüê‰∏™ÁªìÂ±Ä„ÄÇ
ËØ∑ËÆ∞‰ΩèÔºåËøôÊòØ‰∏Ä‰∏™ËßÜËßâÂ∞èËØ¥/GalgameÔºåÊâÄ‰ª•Âèô‰∫ãÈ£éÊ†ºÂ∫îËØ•Á¨¶ÂêàËøô‰∏™Á±ªÂûãÔºåÂπ∂‰∏îÈúÄË¶ÅÊúâÈÄÇÂΩìÁöÑÂú∫ÊôØÂíåËßíËâ≤ÊèèËø∞„ÄÇ`;

                // ÂàõÂª∫ÂàùÂßãÂåñÊèêÁ§∫ÂéÜÂè≤
                const setupHistory = [
                    {
                        role: "user",
                        parts: [{ text: initPrompt }],
                        isSetup: true,
                        storyMetadata: storyMetadata
                    }
                ];

                // Ë∞ÉÁî®APIÂºÄÂßãÊïÖ‰∫ã
                setLoading(true);
                try {
                    const response = await callLLMApi_Galgame(setupHistory);
                    processGameResponse(response);
                    isGameStarted = true;
                } catch (error) {
                    showGameError("ÂàùÂßãÂåñÊïÖ‰∫ãÊó∂Âá∫Èîô: " + error.message);
                } finally {
                    setLoading(false);
                }
            }

            // --- LLM APIË∞ÉÁî® ---
            async function callLLMApi_Galgame(promptHistory) {
                console.log("ÂºÄÂßãË∞ÉÁî®LLM API...");
                if (!currentApiKey || !currentModel || !currentApiUrl) {
                    showGameError("API ÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºÅËØ∑Ê£ÄÊü•ËÆæÁΩÆ„ÄÇ");
                    const fallbackData = {
                        scene_state: {
                            background_prompt: "error config",
                            visible_characters: []
                        },
                        dialogue_segments: [
                            {
                                speaker: "Á≥ªÁªü",
                                text: "API ÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºÅËØ∑Ê£ÄÊü•ËÆæÁΩÆ„ÄÇ"
                            }
                        ],
                        story_metadata: StoryTracker.metadata
                    };

                    // Á°Æ‰øùÈîôËØØË¢´Ê∑ªÂä†Âà∞ÂéÜÂè≤‰∏≠ÔºàÂ¶ÇÊûúÊ∏∏ÊàèÂ∑≤ÁªèÂºÄÂßãÔºâ
                    if (isGameStarted && (!conversationHistory.length || !conversationHistory[conversationHistory.length - 1].isErrorFallback)) {
                        conversationHistory.push({
                            role: "model",
                            parts: [{ text: JSON.stringify(fallbackData) }],
                            isErrorFallback: true
                        });
                    }

                    return fallbackData;
                }

                clearGameError();
                let finalApiUrl = currentApiUrl.trim();
                let requestBody;
                let headers = { 'Content-Type': 'application/json' };
                const isFirstCall = promptHistory.length === 1 && promptHistory[0].isSetup;
                let userPromptText = isFirstCall ?
                    promptHistory[0].parts[0].text :
                    promptHistory[promptHistory.length - 1].parts[0].text;

                // Á≥ªÁªüÊåá‰ª§ÔºàÂåÖÂê´ÊïÖ‰∫ãËßÑÂàíË¶ÅÊ±ÇÔºâ
                const systemInstruction = `‰Ω†Áé∞Âú®ÊòØ‰∏Ä‰∏™ Galgame (ËßÜËßâÂ∞èËØ¥) ÂºïÊìé„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØ‰∏éÁé©ÂÆ∂ (${playerName || 'Áé©ÂÆ∂'}) ‰∫íÂä®ÔºåÂπ∂ÁîüÊàêÊ∏∏ÊàèÂÜÖÂÆπ„ÄÇ
Áé©ÂÆ∂Âü∫Á°ÄÂ§ñË≤åÊèêÁ§∫ËØç(Áî±‰Ω†ÁîüÊàêÊàñÂÆåÂñÑ): ${playerBaseAppearancePrompt || '(Â∞öÊú™ÁîüÊàê)'}\nAIËßíËâ≤Âü∫Á°ÄÂ§ñË≤åÊèêÁ§∫ËØç(Áî±‰Ω†ÁîüÊàêÊàñÂÆåÂñÑ): ${aiBaseAppearancePrompt || '(Â∞öÊú™ÁîüÊàê)'}\n${currentAiPersona ? `AI ËßíËâ≤ËÆæÂÆö: ${currentAiPersona}\n` : ''}ËØ∑**‰∏•Ê†º**ÊåâÁÖß‰ª•‰∏ã JSON Ê†ºÂºèÁîüÊàêÂìçÂ∫îÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïÈ¢ùÂ§ñÁöÑËß£ÈáäÊàñ Markdown Ê†áËÆ∞ÂåÖË£π JSON Êú¨Ë∫´Ôºö\n\`\`\`json\n{\n  "scene_state": {\n    "background_prompt": "String (Âú∫ÊôØÁöÑËã±ÊñáÊèèËø∞, ËøôÊòØÊ∏∏ÊàèËÉåÊôØÂõæ, ‰∏çÊòØËßíËâ≤Á´ãÁªòËÉåÊôØ!)",\n    "visible_characters": [\n      {\n        "character_id": "String ('player' or 'ai')",\n        "emotion": "String or Null (ËßíËâ≤„ÄêÂΩìÂâç„ÄëÁöÑË°®ÊÉÖ/Âä®‰Ωú/ÁªÜÂæÆÂèòÂåñ, e.g., 'smiling slightly', 'surprised face', 'holding a pen', 'adjusting glasses')"\n      }\n      // ... ÂèØËÉΩÂåÖÂê´ 'player' Âíå/Êàñ 'ai'\n    ]\n  },\n  "dialogue_segments": [\n    {\n      "speaker": "String (AIËßíËâ≤Âêç, ${playerName ? "'" + playerName + "'" : "'Áé©ÂÆ∂'"}, 'ÊóÅÁôΩ', 'ÂÜÖÂøÉÊÉ≥Ê≥ï')",\n      "emotion": "String or Null (ËØ¥ËØùËÄÖË°®ÊÉÖ/Âä®‰Ωú, ÂØπÂ∫îÊ≠§„ÄêÂØπËØù„ÄëÂÜÖÂÆπ)",\n      "text": "String (ËØ•ÁâáÊÆµÁöÑÂØπËØù/ÊóÅÁôΩÊñáÊú¨, ÊîØÊåÅMarkdown)"\n    }\n    // ... more segments\n  ],\n  "choices": [\n    "String (ÈÄâÈ°π1)", \n    "String (ÈÄâÈ°π2)"\n  ],\n  "story_metadata": {\n    "progress": 50, // Number: ÂÆåÊàêÂ∫¶ÁôæÂàÜÊØî, 0-100\n    "currentAct": 2, // Number: ÂΩìÂâçÁ´†ËäÇÁºñÂè∑\n    "totalActs": 3, // Number: ÊÄªÁ´†ËäÇÊï∞\n    "branchPath": "main", // String: ÂΩìÂâçÊïÖ‰∫ãÂàÜÊîØ\n    "remainingTurns": 8, // Number: È¢ÑËÆ°Ââ©‰ΩôÂõûÂêàÊï∞\n    "currentEnding": null // ObjectÊàñnull: ÂΩìËøõÂ∫¶<90%Êó∂‰∏∫nullÔºåÊé•ËøëÁªìÂ±ÄÊó∂‰∏∫ÂåÖÂê´type/name/descriptionÁöÑÂØπË±°\n    /* ÁªìÂ±ÄÁ§∫‰æãÔºö\n    "currentEnding": {\n      "type": "good", // String: 'good', 'neutral', Êàñ 'bad'\n      "name": "Âπ∏Á¶èÁöÑÁ∫¶ÂÆö", // String: ÁªìÂ±ÄÂêçÁß∞\n      "description": "Âú®ÁªèÂéÜ‰∫ÜÈáçÈáçÂõ∞ÈöæÂêé..." // String: ÁªìÂ±ÄËØ¶ÁªÜÊèèËø∞\n    }\n    */\n  },\n  "initial_setup_details": { \n     // !!! Ëøô‰∏™Â≠óÊÆµ„ÄêÂè™Âú®„ÄëÂìçÂ∫îÁ¨¨‰∏Ä‰∏™ËÆæÁΩÆËØ∑Ê±ÇÊó∂Âá∫Áé∞ !!!\n     // **Ë¶ÅÊ±ÇÔºöÁîüÊàê„ÄêÁÆÄË¶Å‰∏îËøûË¥Ø„Äë„ÄÅÂåÖÂê´ÂÖ∑‰ΩìÁâπÂæÅ(ÂèëÂûã/ÂèëËâ≤/Áû≥Ëâ≤/Ë∫´Êùê/ËÑ∏Âûã)Âíå„ÄêÂÖ∑‰ΩìÊúçË£Ö„ÄëÊèèËø∞ÁöÑÂü∫Á°ÄÊèêÁ§∫ËØç(50-80‰∏™Ëã±ÊñáÂçïËØç)„ÄÇ**„ÄêÁ¶ÅÊ≠¢„Äë**ÂåÖÂê´‰∫∫ÂêçÊàñËßíËâ≤ÂêçÁß∞Ôºå‰ª•Âèä 'same character', 'same face', 'same style' Á≠âÊó†ÊïàËØçËØ≠„ÄÇ**\n     "player_base_appearance_prompt": "String (ÁîüÊàê„ÄêÁÆÄË¶Å„ÄÅËøûË¥Ø„ÄëÁöÑÁé©ÂÆ∂Âü∫Á°ÄÂ§ñË≤åËã±ÊñáÊèêÁ§∫ËØç, e.g., '1girl, medium height, slim build, long wavy bright pink hair tied in high twin tails with red ribbons, large sparkling emerald green eyes, fair skin, wearing a standard white short-sleeve sailor school uniform with navy blue collar and cuffs, red necktie, navy blue pleated skirt, white knee-high socks, brown loafers')",\n     "ai_base_appearance_prompt": "String (ÁîüÊàê„ÄêÁÆÄË¶Å„ÄÅËøûË¥Ø„ÄëÁöÑAIËßíËâ≤Âü∫Á°ÄÂ§ñË≤åËã±ÊñáÊèêÁ§∫ËØç, Âêå‰∏äË¶ÅÊ±Ç)"\n  }\n}\n\`\`\`\n*   **scene_state**: ÊèèËø∞ÂΩìÂâçÂú∫ÊôØËßÜËßâÁä∂ÊÄÅ„ÄÇ\n    *   **background_prompt**: ÂΩìÂâçÂú∫ÊôØÁöÑ„ÄêÊ∏∏ÊàèËÉåÊôØÂõæ„ÄëÊèêÁ§∫ËØç„ÄÇ\n    *   **visible_characters**: Êï∞ÁªÑÂåÖÂê´ÂΩìÂâçÂ±èÂπï‰∏äÂèØËßÅÁöÑËßíËâ≤„ÄÇÊØè‰∏™ÂØπË±°ÊåáÂÆö \`character_id\` ('player' Êàñ 'ai') Âíå \`emotion\`„ÄÇ \`emotion\` ÂøÖÈ°ªÊòØ„ÄêÊûÅÂÖ∂ÁÆÄÊ¥ÅÂú∞ÊèèËø∞ÂΩìÂâçË°®ÊÉÖ„ÄÅÂä®‰ΩúÊàñÈùûÂ∏∏Â∞èÁöÑ‰∏¥Êó∂Áâ©ÂìÅ„ÄëÔºå‰æãÂ¶Ç 'smiling', 'sad', 'surprised', 'holding a book', 'waving hand', 'blushing', 'looking down shyly'„ÄÇ**„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë** Âú® \`emotion\` Â≠óÊÆµ‰∏≠ÈáçÊñ∞ÊèèËø∞ËßíËâ≤ÁöÑÊ†∏ÂøÉÁâπÂæÅÔºàÂ¶ÇÂèëÂûã„ÄÅÂèëËâ≤„ÄÅÁû≥Ëâ≤Ôºâ„ÄÅ‰∏ªË¶ÅÊúçË£ÖÊàñÊï¥‰ΩìËâ∫ÊúØÈ£éÊ†ºÔºå‰πü**„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë**ÂåÖÂê´ 'same character/face/style/clothing' Á≠âËØçËØ≠„ÄÇÂÆ¢Êà∑Á´Ø‰ºöÂº∫Âà∂Â∫îÁî®‰∏ÄËá¥ÁöÑÊó•Âºè‰∫åÊ¨°ÂÖÉÁîªÈ£éÂíåÁ∫ØÁôΩËÉåÊôØ„ÄÇ\n*   **dialogue_segments**: ÂØπËØùÂÜÖÂÆπÊï∞ÁªÑ„ÄÇ\n*   **choices**: Áé©ÂÆ∂ÈÄâÈ°πÊï∞ÁªÑ„ÄÇ\n*   **story_metadata**: ÊïÖ‰∫ãËøõÂ∫¶Êï∞ÊçÆÔºåÂåÖÊã¨Ôºö\n    *   **progress**: Êï∞Â≠óÁ±ªÂûãÔºåÂÆåÊàêÂ∫¶ÁôæÂàÜÊØî (0-100)\n    *   **currentAct**: Êï∞Â≠óÁ±ªÂûãÔºåÂΩìÂâçÁ´†ËäÇÁºñÂè∑\n    *   **totalActs**: Êï∞Â≠óÁ±ªÂûãÔºåÊÄªÁ´†ËäÇÊï∞\n    *   **branchPath**: Â≠óÁ¨¶‰∏≤Á±ªÂûãÔºåÂΩìÂâçÊïÖ‰∫ãÂàÜÊîØ\n    *   **remainingTurns**: Êï∞Â≠óÁ±ªÂûãÔºåÈ¢ÑËÆ°Ââ©‰ΩôÂõûÂêàÊï∞\n    *   **currentEnding**: ÂØπË±°Á±ªÂûãÊàñnullÔºåÂΩìËøõÂ∫¶Êé•Ëøë100%Êó∂ÔºåÂ°´ÂÜôÁªìÂ±Ä‰ø°ÊÅØ\n*   **initial_setup_details**: „ÄêÂè™Âú®È¶ñÊ¨°ÂìçÂ∫îÊó∂Êèê‰æõ„ÄëÔºåÂåÖÂê´‰Ω†ÁîüÊàêÁöÑ„ÄêÁÆÄË¶Å(50-80‰∏™Ëã±ÊñáÂçïËØç)„ÄÅËøûË¥Ø‰∏î‰∏çÂê´‰∫∫ÂêçÊàñÊó†ÊïàÈáçÂ§çËØç„ÄëÁöÑÂü∫Á°ÄÂ§ñË≤åÊèêÁ§∫ËØç„ÄÇ\n*   **È£éÊ†ºÂíåÁ´ãÁªòËÉåÊôØ**: ÂÆ¢Êà∑Á´Ø‰ºöÂº∫Âà∂‰ΩøÁî®Âõ∫ÂÆöÁöÑ„ÄêÊó•Âºè‰∫åÊ¨°ÂÖÉËßÜËßâÂ∞èËØ¥Á´ãÁªòÈ£éÊ†º„ÄëÂíå„ÄêÁ∫ØÁôΩËÉåÊôØ„ÄëÊù•ÁîüÊàêËßíËâ≤Á´ãÁªò„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊèê‰æõËØ¶ÁªÜÁöÑÂü∫Á°ÄÊèèËø∞ÂíåÁÆÄÊ¥ÅÁöÑÁä∂ÊÄÅÂèòÂåñÔºåÂπ∂ÈÅøÂÖçÊó†ÊïàÂÖ≥ÈîÆËØç„ÄÇ

            *   **Êï∞Â≠¶ÂÖ¨Âºè**: ÂΩìÂØπËØùÊàñÊóÅÁôΩ‰∏≠ÈúÄË¶ÅÂ±ïÁ§∫Êï∞Â≠¶ÂÖ¨Âºè„ÄÅÂåñÂ≠¶ÊñπÁ®ãÂºèÊàñÂÖ∂‰ªñÁßëÂ≠¶Á¨¶Âè∑Êó∂ÔºåËØ∑‰ΩøÁî® LaTeX Ê†ºÂºè„ÄÇ

*   ÂØπ‰∫é**Ë°åÂÜÖÂÖ¨Âºè** (ÂµåÂÖ•ÊñáÊú¨‰∏≠)ÔºåËØ∑‰ΩøÁî®Âçï‰∏™ÁæéÂÖÉÁ¨¶Âè∑ÂåÖË£πÔºå‰æãÂ¶ÇÔºö\`Áà±Âõ†ÊñØÂù¶ÁöÑË¥®ËÉΩÊñπÁ®ãÊòØ \$E=mc^2\`„ÄÇ
*   ÂØπ‰∫é**ÂùóÁ∫ßÂÖ¨Âºè** (ÂçïÁã¨ÊàêË°åÂ±ïÁ§∫)ÔºåËØ∑‰ΩøÁî®ÂèåÁæéÂÖÉÁ¨¶Âè∑ÂåÖË£πÔºå‰æãÂ¶ÇÔºö\`\$\$\int_{-\infty}^{\infty} e^{-x^2} dx = \\sqrt{\pi}\$\$ \`
                *   ËØ∑Á°Æ‰øù LaTeX ËØ≠Ê≥ïÊ≠£Á°ÆÔºåÂπ∂Â∞ΩÈáè‰ΩøÁî®Â∏∏Áî®„ÄÅÂÖºÂÆπÊÄßÂ•ΩÁöÑÂëΩ‰ª§„ÄÇ
ÂΩìÊïÖ‰∫ãËøõË°åÂà∞70%‰ª•‰∏äÊó∂ÔºåÂºÄÂßãÂºïÂØºÁé©ÂÆ∂Ëµ∞ÂêëÊüê‰∏™È¢ÑËÆæÁªìÂ±Ä„ÄÇ
‰∏çË¶ÅË∂ÖËøáÈ¢ÑÂÆöÂõûÂêàÊï∞Â∞±Ë¶ÅÁªìÊùüÊïÖ‰∫ãÔºàÁü≠ÁØáÁ∫¶10ÂõûÂêàÔºå‰∏≠ÁØáÁ∫¶15ÂõûÂêàÔºåÈïøÁØáÁ∫¶20ÂõûÂêàÔºâ„ÄÇ

Ê≥®ÊÑèÔºö‰∏çË¶ÅËØ¥"Âêå‰∏ä"Êàñ"‰øùÊåÅ‰∏çÂèò"Á≠âÊ®°Á≥äËØçËØ≠ÔºåÊÄªÊòØËØ¶ÁªÜÊèèËø∞ÂÆåÊï¥ÁöÑÂú∫ÊôØÂíåËßíËâ≤Áä∂ÊÄÅ„ÄÇ`;

                // Ê∑ªÂä†ÊïÖ‰∫ãË∑üË∏™Êï∞ÊçÆÂà∞ÊØè‰∏™ËØ∑Ê±Ç
                const storyTrackingPrompt = `
„ÄêÊïÖ‰∫ãËøõÂ∫¶Ë∑üË∏™„Äë
- ÂΩìÂâçËøõÂ∫¶: ${StoryTracker.metadata.progress}%
- ÂΩìÂâçÂàÜÊîØ: ${StoryTracker.metadata.branchPath}
- Ââ©‰ΩôÂõûÂêà: ${StoryTracker.metadata.remainingTurns}
- ÁõÆÊ†áÔºöÁ°Æ‰øùÊïÖ‰∫ãÂú®Ââ©‰ΩôÂõûÂêàÂÜÖÊé®ËøõÂà∞ÁªìÂ±ÄÔºå‰∏çË¶ÅÊó†ÈôêÂª∂Áª≠

ÊØèÊ¨°ÂõûÂ∫îÈÉΩÂøÖÈ°ªÂú®JSON‰∏≠ÂåÖÂê´story_metadataÂ≠óÊÆµÔºåÊõ¥Êñ∞ËøõÂ∫¶‰ø°ÊÅØ„ÄÇ
ÂΩìËøõÂ∫¶Ë∂ÖËøá70%Êó∂ÔºåÂºÄÂßãÂºïÂØºÊïÖ‰∫ãËµ∞ÂêëÊüê‰∏™È¢ÑËÆæÁªìÂ±Ä„ÄÇ
`;

                try {
                    // ÊûÑÂª∫APIËØ∑Ê±Ç‰Ωì
                    if (finalApiUrl.includes('generativelanguage.googleapis.com')) {
                        // Gemini APIÁªìÊûÑ
                        if (!finalApiUrl.includes('/v1beta/models')) {
                            finalApiUrl = finalApiUrl.replace(/\/$/, '') + `/v1beta/models/${currentModel}:generateContent?key=${currentApiKey}`;
                        } else {
                            finalApiUrl += `?key=${currentApiKey}`;
                        }

                        let geminiContents = [];

                        // Ê∑ªÂä†ÊïÖ‰∫ãË∑üË∏™ÊèêÁ§∫
                        geminiContents.push({
                            role: 'user',
                            parts: [{ text: storyTrackingPrompt }]
                        });
                        geminiContents.push({
                            role: 'model',
                            parts: [{ text: "Êàë‰ºöÊåâÁÖßÊåáÁ§∫Ë∑üË∏™ÊïÖ‰∫ãËøõÂ∫¶Âπ∂Á°Æ‰øùÈÄÇÂΩìÁªìÊùü„ÄÇ" }]
                        });

                        // Ê∑ªÂä†ÂØπËØùÂéÜÂè≤
                        promptHistory.slice(0, isFirstCall ? -1 : undefined)
                            .slice(-7).forEach(h => {
                                const role = (h.role === 'model' ? 'model' : 'user');
                                if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                                    if (role === 'model') {
                                        geminiContents.push({ role: 'user', parts: [{ text: "(Continue...)" }] });
                                    } else {
                                        geminiContents.push({ role: 'model', parts: [{ text: "{}" }] });
                                    }
                                }
                                geminiContents.push({ role: role, parts: [{ text: h.parts[0].text }] });
                            });

                        let currentUserParts = [];
                        if (isFirstCall) {
                            const playerData = getImageDataFromBase64(playerImageBase64);
                            if (playerData) {
                                currentUserParts.push({
                                    inline_data: {
                                        mime_type: playerData.mimeType,
                                        data: playerData.data
                                    }
                                });
                                console.log("Â∞ÜÁé©ÂÆ∂ÂõæÁâáÊ∑ªÂä†Âà∞GeminiËØ∑Ê±Ç");
                            }

                            const aiData = getImageDataFromBase64(aiImageBase64);
                            if (aiData) {
                                currentUserParts.push({
                                    inline_data: {
                                        mime_type: aiData.mimeType,
                                        data: aiData.data
                                    }
                                });
                                console.log("Â∞ÜAIÂõæÁâáÊ∑ªÂä†Âà∞GeminiËØ∑Ê±Ç");
                            }
                        }

                        currentUserParts.push({ text: userPromptText }); // ÊñáÊú¨ÊèêÁ§∫ÊúÄÂêéÊ∑ªÂä†

                        if (geminiContents.length === 0 || geminiContents[geminiContents.length - 1].role === 'model') {
                            geminiContents.push({ role: 'user', parts: currentUserParts });
                        } else {
                            console.warn("GeminiÂèØËÉΩÂ≠òÂú®Èùû‰∫§ÊõøÂØπËØùÁªìÊûÑÈóÆÈ¢ò„ÄÇ");
                            geminiContents.push({ role: 'user', parts: currentUserParts });
                        }

                        requestBody = JSON.stringify({
                            contents: geminiContents,
                            generationConfig: {
                                responseMimeType: "application/json"
                            }
                        });
                    } else if (finalApiUrl.includes('/v1')) {
                        // OpenAIÂÖºÂÆπAPIÁªìÊûÑ
                        headers['Authorization'] = `Bearer ${currentApiKey}`;
                        if (!finalApiUrl.includes('/chat/completions')) {
                            finalApiUrl = finalApiUrl.replace(/\/v1\/?$/, '') + '/v1/chat/completions';
                        }

                        let openAiMessages = [];

                        // Á≥ªÁªüÊåá‰ª§ÂåÖÂê´ÊïÖ‰∫ãË∑üË∏™ÊèêÁ§∫
                        openAiMessages.push({
                            "role": "system",
                            "content": systemInstruction + "\n\n" + storyTrackingPrompt
                        });

                        // Ê∑ªÂä†ÂØπËØùÂéÜÂè≤
                        promptHistory.slice(0, isFirstCall ? -1 : undefined)
                            .slice(-7).forEach(h => {
                                openAiMessages.push({
                                    role: h.role === 'model' ? 'assistant' : 'user',
                                    content: h.parts[0].text
                                });
                            });

                        let currentUserContent = [];
                        currentUserContent.push({
                            type: "text",
                            text: userPromptText
                        });

                        // Âú®È¶ñÊ¨°Ë∞ÉÁî®Êó∂Â§ÑÁêÜÂõæÁâá
                        if (isFirstCall) {
                            if (playerImageBase64) {
                                currentUserContent.push({
                                    type: "image_url",
                                    image_url: { url: playerImageBase64 }
                                });
                                console.log("Â∞ÜÁé©ÂÆ∂ÂõæÁâáÊ∑ªÂä†Âà∞OpenAIËØ∑Ê±Ç");
                            }
                            if (aiImageBase64) {
                                currentUserContent.push({
                                    type: "image_url",
                                    image_url: { url: aiImageBase64 }
                                });
                                console.log("Â∞ÜAIÂõæÁâáÊ∑ªÂä†Âà∞OpenAIËØ∑Ê±Ç");
                            }
                        }

                        openAiMessages.push({
                            role: "user",
                            content: currentUserContent
                        });

                        requestBody = JSON.stringify({
                            model: currentModel,
                            messages: openAiMessages,
                            max_tokens: 65536,
                            response_format: { type: "json_object" }
                        });
                    } else {
                        throw new Error("Êó†Ê≥ïËØÜÂà´ÁöÑ API Âü∫Á°ÄÂú∞ÂùÄÊ†ºÂºè„ÄÇ");
                    }

                    console.log("Ë∞ÉÁî®Galgame LLM API:", finalApiUrl);

                    const response = await fetch(finalApiUrl, {
                        method: 'POST',
                        headers,
                        body: requestBody
                    });

                    console.log("LLM APIÂìçÂ∫îÁä∂ÊÄÅ:", response.status);

                    // Â¢ûÂº∫ÁöÑÂìçÂ∫îÂ§ÑÁêÜÂíåË∞ÉËØï
                    let data;
                    try {
                        data = await response.json();
                        console.log("LLM APIÂéüÂßãÂìçÂ∫îÊï∞ÊçÆ:", JSON.stringify(data, null, 2).substring(0, 500) + "...");
                    } catch (jsonError) {
                        console.error("Êó†Ê≥ïÂ∞ÜAPIÂìçÂ∫îËß£Êûê‰∏∫JSON:", jsonError);
                        try {
                            const textResponse = await response.text();
                            console.error("APIÂéüÂßãÊñáÊú¨ÂìçÂ∫î:", textResponse.substring(0, 500) + "...");
                            throw new Error(`APIÂìçÂ∫î‰∏çÊòØÊúâÊïàÁöÑJSONÊ†ºÂºè: ${textResponse.substring(0, 100)}...`);
                        } catch (textError) {
                            console.error("Êó†Ê≥ïËé∑ÂèñÊñáÊú¨ÂìçÂ∫î„ÄÇ");
                            throw new Error("APIÂìçÂ∫î‰∏çÊòØÊúâÊïàÁöÑJSONÊ†ºÂºèÔºå‰∏îÊó†Ê≥ïËØªÂèñÊñáÊú¨ÂÜÖÂÆπ„ÄÇ");
                        }
                    }

                    // Ê£ÄÊü•ÂìçÂ∫îÊòØÂê¶ÊàêÂäü
                    if (!response.ok) {
                        let errorMsg = `API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`;
                        if (data && data.error && data.error.message) {
                            errorMsg += `\nËØ¶ÊÉÖ: ${data.error.message}`;
                        } else {
                            errorMsg += `\nËØ¶ÊÉÖ: ${JSON.stringify(data)}`;
                        }
                        throw new Error(errorMsg);
                    }

                    // ÊèêÂèñÂÜÖÂÆπ
                    let responseContent = null;
                    if (data && data.error && (data.error.message || data.error.code)) {
                        console.error("APIËøîÂõûÈîôËØØÂØπË±°:", data.error);
                        throw new Error(`APIÈîôËØØ: ${data.error.message || `Code ${data.error.code}`}`);
                    } else if (data.candidates?.[0]?.finishReason && data.candidates[0].finishReason !== "STOP") {
                        // Gemini: Ê£ÄÊü•ÂÆåÊàêÂéüÂõ†ÊòØÂê¶ÂºÇÂ∏∏
                        console.error("GeminiËØ∑Ê±ÇÈùûÊ≠£Â∏∏ÁªìÊùü:", data.candidates[0].finishReason, data.promptFeedback);
                        let reason = data.candidates[0].finishReason;
                        if (data.promptFeedback?.blockReason) {
                            reason += ` (Block Reason: ${data.promptFeedback.blockReason})`;
                        }
                        throw new Error(`ËØ∑Ê±ÇË¢´ÁªàÊ≠¢: ${reason}`);
                    } else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        responseContent = data.candidates[0].content.parts[0].text;
                    } else if (data.choices?.[0]?.finish_reason && data.choices[0].finish_reason !== "stop") {
                        // OpenAI: Ê£ÄÊü•ÂÆåÊàêÂéüÂõ†
                        console.error("OpenAIËØ∑Ê±ÇÈùûÊ≠£Â∏∏ÁªìÊùü:", data.choices[0].finish_reason);
                        throw new Error(`ËØ∑Ê±ÇË¢´ÁªàÊ≠¢: ${data.choices[0].finish_reason}`);
                    } else if (data.choices?.[0]?.message?.content) {
                        responseContent = data.choices[0].message.content;
                    } else if (data.choices?.[0]?.error) {
                        console.error("APIÂú®choices‰∏≠ËøîÂõûÈîôËØØ:", data.choices[0].error);
                        throw new Error(`APIÈîôËØØ: ${data.choices[0].error.message || JSON.stringify(data.choices[0].error)}`);
                    } else {
                        console.error("Êó†Ê≥ï‰ªéAPIÂìçÂ∫î‰∏≠ÊèêÂèñÂÜÖÂÆπ„ÄÇ", data);
                        throw new Error("Êó†Ê≥ï‰ªé API ÂìçÂ∫î‰∏≠ÊèêÂèñÊúâÊïàÂÜÖÂÆπ„ÄÇ");
                    }

                    console.log("ÊèêÂèñÁöÑÂìçÂ∫îÂÜÖÂÆπ(Ëß£ÊûêÂâç):", responseContent.substring(0, 500) + "...");

                    // JSONËß£ÊûêÂíåÈ™åËØÅ
                    let parsedData;
                    try {
                        const cleanedText = responseContent.replace(/^```json\s*|```$/gs, '').trim();
                        if (!cleanedText) {
                            throw new Error("ÊèêÂèñÂà∞ÁöÑÂÜÖÂÆπ‰∏∫Á©∫Â≠óÁ¨¶‰∏≤„ÄÇ");
                        }
                        parsedData = JSON.parse(cleanedText);

                        // Â∞ÜÂìçÂ∫îÊ∑ªÂä†Âà∞ÂØπËØùÂéÜÂè≤
                        conversationHistory.push({
                            role: "user",
                            parts: [{ text: userPromptText }]
                        });
                        conversationHistory.push({
                            role: "model",
                            parts: [{ text: cleanedText }]
                        });

                        // Êõ¥Êñ∞ÊïÖ‰∫ãË∑üË∏™Âô®
                        StoryTracker.updateFromAIResponse(parsedData);

                        return parsedData;
                    } catch (parseError) {
                        console.error("JSONËß£ÊûêÈîôËØØ:", parseError);
                        console.log("Â∞ùËØïËß£ÊûêÁöÑÊñáÊú¨:", responseContent);

                        // Â∞ùËØï‰ΩøÁî®Ê≠£ÂàôÊèêÂèñJSON
                        const jsonRegex = /{[\s\S]*}/;
                        const match = responseContent.match(jsonRegex);
                        if (match) {
                            try {
                                parsedData = JSON.parse(match[0]);
                                console.log("‰ΩøÁî®Ê≠£ÂàôÊèêÂèñÁöÑJSONÊàêÂäüËß£Êûê„ÄÇ");

                                conversationHistory.push({
                                    role: "user",
                                    parts: [{ text: userPromptText }]
                                });
                                conversationHistory.push({
                                    role: "model",
                                    parts: [{ text: match[0] }]
                                });

                                StoryTracker.updateFromAIResponse(parsedData);
                                return parsedData;
                            } catch (regexParseError) {
                                console.error("Ê≠£ÂàôÊèêÂèñÁöÑJSONËß£ÊûêÂ§±Ë¥•:", regexParseError);
                            }
                        }

                        throw new Error("Êó†Ê≥ïËß£ÊûêAPIÂìçÂ∫î‰∏∫ÊúâÊïàJSON„ÄÇ");
                    }
                } catch (error) {
                    console.error("Ë∞ÉÁî®LLM APIÊó∂Âá∫Èîô:", error);
                    showGameError(`APIÈîôËØØ: ${error.message}`);

                    // ËøîÂõûÈîôËØØÁä∂ÊÄÅ
                    const errorResponse = {
                        scene_state: {
                            background_prompt: "error",
                            visible_characters: []
                        },
                        dialogue_segments: [{
                            speaker: "Á≥ªÁªü",
                            text: `ÂèëÁîüÈîôËØØ: ${error.message}`
                        }],
                        story_metadata: StoryTracker.metadata
                    };

                    return errorResponse;
                }
            }

            // --- Â§ÑÁêÜÊ∏∏ÊàèÂìçÂ∫î ---
            // --- Â§ÑÁêÜÊ∏∏ÊàèÂìçÂ∫î ---
            // --- Â§ÑÁêÜÊ∏∏ÊàèÂìçÂ∫î ---
            async function processGameResponse(data) {
                console.log("Â§ÑÁêÜÊ∏∏ÊàèÂìçÂ∫î:", data);
                // setLoading(true); // Optional: Set loading at the start

                // --- Ê∑ªÂä†ÂºÄÂßã: Â§ÑÁêÜÂπ∂Â≠òÂÇ®ÂàùÂßãÂ§ñËßÇÊèêÁ§∫ËØç ---
                if (data.initial_setup_details) {
                    console.log("Processing initial setup details from API response.");
                    if (data.initial_setup_details.player_base_appearance_prompt) {
                        // Store the received prompt into the global variable
                        playerBaseAppearancePrompt = data.initial_setup_details.player_base_appearance_prompt;
                        console.log("Stored playerBaseAppearancePrompt:", playerBaseAppearancePrompt);
                        // Optional: Store in localStorage if you want it to persist across page loads (but usually not needed for one session)
                        // localStorage.setItem(GALGAME_STORAGE_PREFIX + 'playerBaseAppearancePrompt', playerBaseAppearancePrompt);
                    } else {
                        console.warn("Initial setup details received, but no player_base_appearance_prompt found.");
                    }
                    if (data.initial_setup_details.ai_base_appearance_prompt) {
                        // Store the received prompt into the global variable
                        aiBaseAppearancePrompt = data.initial_setup_details.ai_base_appearance_prompt;
                        console.log("Stored aiBaseAppearancePrompt:", aiBaseAppearancePrompt);
                        // Optional: Store in localStorage
                        // localStorage.setItem(GALGAME_STORAGE_PREFIX + 'aiBaseAppearancePrompt', aiBaseAppearancePrompt);
                    } else {
                        console.warn("Initial setup details received, but no ai_base_appearance_prompt found.");
                    }
                }
                // --- Ê∑ªÂä†ÁªìÊùü ---

                // Â≠òÂÇ®ÂΩìÂâçÂõûÂêàÁöÑÊï∞ÊçÆ
                currentTurnParsedData = data;
                currentTurnChoices = data.choices || [];
                currentDialogueSegments = data.dialogue_segments || [];
                currentSegmentIndex = 0;

                try {
                    // --- Âú∫ÊôØÁä∂ÊÄÅÂ§ÑÁêÜ ---
                    if (data.scene_state) {
                        // Êõ¥Êñ∞ËÉåÊôØ
                        if (data.scene_state.background_prompt) {
                            await loadDynamicImage(gameBackground, data.scene_state.background_prompt, "background");
                        }

                        // Êõ¥Êñ∞ËßíËâ≤ÊòæÁ§∫
                        const characters = data.scene_state.visible_characters || [];
                        let aiCharacterVisible = false;
                        let playerCharacterVisible = false;
                        const characterPromises = [];

                        characters.forEach(char => {
                            const charId = char.character_id; // 'player' or 'ai'
                            const emotion = char.emotion || null;
                            // ---> ‰øÆÊîπ: ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑ÂèñÂü∫Á°ÄÊèêÁ§∫ <---
                            const basePrompt = (charId === 'ai' ? aiBaseAppearancePrompt : playerBaseAppearancePrompt);

                            // ---> Áé∞Âú® basePrompt Â∫îËØ•ÊúâÂÄº‰∫Ü (Â¶ÇÊûúÂàùÂßãËÆæÁΩÆË¢´Ê≠£Á°ÆÂ§ÑÁêÜ) <---
                            if (basePrompt) {
                                const finalPrompt = emotion ? `${basePrompt}, ${emotion}` : basePrompt;
                                console.log(`Â∞ùËØïÂä†ËΩΩËßíËâ≤ ${charId}ÔºåÂü∫Á°ÄÊèêÁ§∫Â≠òÂú®ÔºåÊúÄÁªàÊèêÁ§∫: ${finalPrompt.substring(0, 100)}...`);
                                const spriteElement = (charId === 'ai' ? aiCharacterSprite : playerCharacterSprite);
                                characterPromises.push(loadDynamicImage(spriteElement, finalPrompt, "character"));
                                if (charId === 'ai') aiCharacterVisible = true;
                                else playerCharacterVisible = true;
                            } else {
                                // Ëøô‰∏™Ë≠¶ÂëäÁé∞Âú®Â∫îËØ•Âè™Âú®ÂàùÂßãËÆæÁΩÆÊú™Êî∂Âà∞ÊàñÂ§ÑÁêÜÂ§±Ë¥•Êó∂Âá∫Áé∞
                                console.warn(`ËßíËâ≤ ${charId} Áº∫Â∞ëÂü∫Á°ÄÂ§ñËßÇÊèêÁ§∫ËØçÔºåÊó†Ê≥ïÂä†ËΩΩ„ÄÇ (Base prompt variable is empty)`);
                                const spriteElement = (charId === 'ai' ? aiCharacterSprite : playerCharacterSprite);
                                spriteElement.classList.add('hidden');
                            }
                        });

                        await Promise.all(characterPromises);
                        console.log("ÊâÄÊúâËßíËâ≤ÂõæÁâáÂä†ËΩΩÂÆåÊàê„ÄÇ");

                        if (!aiCharacterVisible) aiCharacterSprite.classList.add('hidden');
                        else aiCharacterSprite.classList.remove('hidden'); // ÊòéÁ°ÆÁßªÈô§ hidden
                        if (!playerCharacterVisible) playerCharacterSprite.classList.add('hidden');
                        else playerCharacterSprite.classList.remove('hidden'); // ÊòéÁ°ÆÁßªÈô§ hidden


                    } else {
                        aiCharacterSprite.classList.add('hidden');
                        playerCharacterSprite.classList.add('hidden');
                    }
                    // --- Âú∫ÊôØÂ§ÑÁêÜÁªìÊùü ---

                    // --- ÂØπËØùÂíåÊåâÈíÆÂ§ÑÁêÜ (‰ΩøÁî®‰πãÂâçÁöÑ‰øÆÊîπÁâàÊú¨) ---
                    if (currentDialogueSegments.length > 0) {
                        displayDialogueSegment(currentSegmentIndex);
                        choicesContainer.innerHTML = ''; // Clear choices initially

                        if (currentDialogueSegments.length > 1) {
                            nextButton.disabled = false;
                            nextButton.textContent = 'ÁªßÁª≠';
                            console.log("ÂìçÂ∫îÊúâÂ§öÊÆµÂØπËØùÔºåÊåâÈíÆËÆæ‰∏∫'ÁªßÁª≠'„ÄÇ");
                        } else { // Only one segment
                            if (currentTurnChoices.length > 0) {
                                displayChoices(); // Display choices now
                                nextButton.disabled = true;
                                nextButton.textContent = 'ËØ∑ÈÄâÊã©';
                                console.log("ÂìçÂ∫îÂè™Êúâ‰∏ÄÊÆµÂØπËØù‰∏îÊúâÈÄâÈ°πÔºåÊòæÁ§∫ÈÄâÈ°πÔºåÁ¶ÅÁî®ÊåâÈíÆ„ÄÇ");
                            } else {
                                nextButton.disabled = false;
                                nextButton.textContent = '‰∏ã‰∏ÄÊ≠•';
                                console.log("ÂìçÂ∫îÂè™Êúâ‰∏ÄÊÆµÂØπËØùÊó†ÈÄâÈ°πÔºåÊåâÈíÆËÆæ‰∏∫'‰∏ã‰∏ÄÊ≠•'„ÄÇ");
                            }
                        }
                    } else {
                        console.warn("APIÂìçÂ∫î‰∏≠Ê≤°ÊúâÂØπËØùÁâáÊÆµ„ÄÇ");
                        dialogueText.innerHTML = "(Ê≤°ÊúâÊî∂Âà∞ÂØπËØùÂÜÖÂÆπ)";
                        speakerName.textContent = "Á≥ªÁªü";
                        choicesContainer.innerHTML = '';
                        nextButton.textContent = '‰∏ã‰∏ÄÊ≠•';
                        nextButton.disabled = false;
                    }
                    // --- ÂØπËØùÂíåÊåâÈíÆÂ§ÑÁêÜÁªìÊùü ---


                    // ÂÖ∂‰ªñÂ§ÑÁêÜ
                    if (data.chapter_marker) renderChapterMarker(data.chapter_marker);
                    if (data.choice_impact) showChoiceImpact(data.choice_impact);
                    StoryTracker.updateFromAIResponse(data);

                } catch (error) {
                    console.error("Â§ÑÁêÜÊ∏∏ÊàèÂìçÂ∫îÊó∂Âá∫Èîô:", error);
                    showGameError(`Â§ÑÁêÜÂìçÂ∫îÊó∂Âá∫Èîô: ${error.message}`);
                    nextButton.disabled = false;
                    nextButton.textContent = 'ÈáçËØï';
                } finally {
                    setLoading(false);
                    console.log("processGameResponse ÂÆåÊàê, ÊúÄÁªàÊåâÈíÆÁä∂ÊÄÅ:", nextButton.disabled);
                }
            }

            // ÊòæÁ§∫Âçï‰∏™ÂØπËØùÈÉ®ÂàÜ
            // ÊòæÁ§∫Âçï‰∏™ÂØπËØùÈÉ®ÂàÜ
            function displayDialogueSegment(index) {
                if (!currentDialogueSegments || index >= currentDialogueSegments.length) {
                    console.error("Êó†ÊïàÁöÑÂØπËØùÊÆµËêΩÁ¥¢Âºï:", index);
                    return;
                }

                const segment = currentDialogueSegments[index];
                speakerName.textContent = segment.speaker || "ÊóÅÁôΩ";

                // ‰ΩøÁî®DOMPurifyÂíåmarkedÂ§ÑÁêÜmarkdown
                const markedOptions = {
                    breaks: true,
                    gfm: true
                };
                const purifiedHtml = DOMPurify.sanitize(marked.parse(segment.text || "", markedOptions));
                dialogueText.innerHTML = purifiedHtml;
                try {
                    renderMathInElement(dialogueText, {
                        // ÈÖçÁΩÆ KaTeX Ëá™Âä®Ê∏≤Êüì
                        delimiters: [
                            { left: "$$", right: "$$", display: true },  // Display mode (ÂùóÁ∫ßÂÖ¨Âºè)
                            { left: "$", right: "$", display: false },   // Inline mode (Ë°åÂÜÖÂÖ¨Âºè)
                            { left: "\\(", right: "\\)", display: false }, // Inline mode (ÂÖºÂÆπ LaTeX)
                            { left: "\\[", right: "\\]", display: true }   // Display mode (ÂÖºÂÆπ LaTeX)
                        ],
                        // Â¶ÇÊûúÈÅáÂà∞ KaTeX ‰∏çÊîØÊåÅÁöÑÂëΩ‰ª§ÔºåÂàôÊäõÂá∫ÈîôËØØ
                        throwOnError: false
                    });
                    console.log("KaTeX rendering applied to dialogue segment.");
                } catch (error) {
                    console.error("KaTeX rendering failed:", error);
                    // Â¶ÇÊûúÊ∏≤ÊüìÂ§±Ë¥•ÔºåHTML ‰ªçÁÑ∂ÊòØÊ∏ÖÁêÜËøáÁöÑ Markdown ÂÜÖÂÆπ
                }

                // Ê∏ÖÈô§‰πãÂâçÁöÑÈÄâÊã© (ÊØèÊ¨°ÂàáÊç¢ÈÉΩÊ∏ÖÁ©∫)
                choicesContainer.innerHTML = '';

                // --- ÁßªÈô§ËøôÊÆµ‰ª£Á†Å ---
                // if (index === currentDialogueSegments.length - 1 && currentTurnChoices.length > 0) {
                //     displayChoices();
                // }
                // --- ÁßªÈô§ÁªìÊùü ---
            }
            // Âè™Ê∑ªÂä†Ëøô‰∏™ÂáΩÊï∞Ôºå‰∏ç‰øÆÊîπ‰ªª‰ΩïÂÖ∂‰ªñ‰ª£Á†Å
            function toggleHistoryPanel() {
                if (isLoading) return;
                if (!isGameStarted || !currentApiKey || !currentModel) {
                    showGameError("Ê∏∏ÊàèÂ∞öÊú™ÂºÄÂßãÔºÅ");
                    return;
                }

                historyPanel.classList.toggle('visible');
                if (historyPanel.classList.contains('visible')) {
                    displayHistory();
                }
            }
            // ÊòæÁ§∫ÈÄâÊã©È°π
            // ÊòæÁ§∫ÈÄâÊã©È°π (Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑ)
            // ÊòæÁ§∫ÈÄâÊã©È°π (Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑÔºåÂπ∂‰º†ÈÄíÂèÇÊï∞ÁªôÂ§ÑÁêÜÂô®)
            // ÊòæÁ§∫ÈÄâÊã©È°π (ÂÜçÊ¨°Âä†Âº∫ÁõëÂê¨Âô®ÂÜÖÈÉ®Êó•Âøó)
            // ÊòæÁ§∫ÈÄâÊã©È°π (Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑÔºåÂπ∂‰º†ÈÄíÂèÇÊï∞ÁªôÂ§ÑÁêÜÂô®)
            // ÊòæÁ§∫ÈÄâÊã©È°π (ÂÜçÊ¨°Âä†Âº∫ÁõëÂê¨Âô®ÂÜÖÈÉ®Êó•Âøó)
            function displayChoices() {
                choicesContainer.innerHTML = ''; // Clear first
                if (!currentTurnChoices || currentTurnChoices.length === 0) {
                    console.log("No choices to display.");
                    return;
                }
                console.log("Displaying choices:", currentTurnChoices);

                const markedOptions = { // Á°Æ‰øù markedOptions ÂÆö‰πâÊàñÂèØËÆøÈóÆ
                    breaks: true,
                    gfm: true
                };

                currentTurnChoices.forEach((choiceText, idx) => {
                    // Âú®Âæ™ÁéØÂºÄÂßãÊó∂ËÆ∞ÂΩïÔºå‰ª•Èò≤ÂêéÁª≠Ë¢´‰øÆÊîπ
                    const capturedText = choiceText;
                    const capturedIndex = idx;

                    console.log(`[displayChoices] Loop ${capturedIndex}, capturedText: "${capturedText}", type: ${typeof capturedText}`);

                    if (typeof capturedText !== 'string' || capturedText.trim() === '') {
                        console.warn(`[displayChoices] Skipping invalid item at index ${capturedIndex}:`, capturedText);
                        return;
                    }

                    const choiceButton = document.createElement('button');
                    choiceButton.className = 'choice-button';

                    // --- ‰øÆÊîπÂºÄÂßã ---
                    // 1. ‰ΩøÁî® innerHTML ËÄå‰∏çÊòØ textContent
                    // 2. ÂÉèÂØπËØùÊñáÊú¨‰∏ÄÊ†∑ÔºåÂÖàÈÄöËøá marked Âíå DOMPurify Â§ÑÁêÜ
                    const purifiedChoiceHtml = DOMPurify.sanitize(marked.parse(capturedText || "", markedOptions));
                    choiceButton.innerHTML = purifiedChoiceHtml;
                    // --- ‰øÆÊîπÁªìÊùü ---

                    choiceButton.dataset.choiceIndex = capturedIndex;

                    choiceButton.addEventListener('click', (event) => {
                        console.log(`[Listener Executed] Button clicked!`);
                        console.log(`[Listener Executed]   - Button textContent at click time: "${event.target.textContent}"`);
                        console.log(`[Listener Executed]   - Captured text from forEach loop: "${capturedText}" (type: ${typeof capturedText})`);
                        console.log(`[Listener Executed]   - Captured index from forEach loop: ${capturedIndex}`);
                        console.log(`[Listener Executed]   - About to call handleChoiceClick with: text="${capturedText}", index=${capturedIndex}`);
                        handleChoiceClick(capturedText, capturedIndex);
                    });

                    choicesContainer.appendChild(choiceButton);
                    console.log(`[displayChoices] Appended button for index ${capturedIndex}: "${capturedText}"`);
                });

                // --- Ê∑ªÂä†ÂºÄÂßã ---
                // 3. Âú®ÊâÄÊúâÊåâÈíÆÊ∑ªÂä†Âà∞ÂÆπÂô®ÂêéÔºåÂØπÂÆπÂô®Â∫îÁî® KaTeX Ê∏≤Êüì
                try {
                    renderMathInElement(choicesContainer, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false },
                            { left: "\\(", right: "\\)", display: false },
                            { left: "\\[", right: "\\]", display: true }
                        ],
                        throwOnError: false
                    });
                    console.log("KaTeX rendering applied to choices container.");
                } catch (error) {
                    console.error("KaTeX rendering failed for choices container:", error);
                }
                // --- Ê∑ªÂä†ÁªìÊùü ---

                console.log("Finished appending choice buttons. Container children:", choicesContainer.children.length);
            }

            // Â§ÑÁêÜÈÄâÊã©ÁÇπÂáª (‰ªé‰∫ã‰ª∂ÁõÆÊ†áËé∑ÂèñÊñáÊú¨)
            // Â§ÑÁêÜÈÄâÊã©ÁÇπÂáª (Êé•Êî∂ÊñáÊú¨ÂíåÁ¥¢Âºï‰Ωú‰∏∫ÂèÇÊï∞)
            // Â§ÑÁêÜÈÄâÊã©ÁÇπÂáª (Êé•Êî∂ÊñáÊú¨ÂíåÁ¥¢Âºï‰Ωú‰∏∫ÂèÇÊï∞)
            async function handleChoiceClick(choiceText, choiceIndex) {
                console.log(`[handleChoiceClick START] Received choiceText: "${choiceText}" (type: ${typeof choiceText}), choiceIndex: ${choiceIndex}`);

                if (isLoading) {
                    console.log("[handleChoiceClick] Loading... Click ignored.");
                    return;
                }

                // ÂÜçÊ¨°‰∏•Ê†ºÊ£ÄÊü•‰º†ÂÖ•ÁöÑÂÄº
                if (typeof choiceText !== 'string' || choiceText.trim() === '') {
                    console.error("[handleChoiceClick] ERROR: Invalid choiceText received:", choiceText);
                    showGameError("ÂÜÖÈÉ®ÈîôËØØÔºöÂ§ÑÁêÜÈÄâÈ°πÊó∂ÊñáÊú¨Êó†Êïà„ÄÇ");
                    // ÂèØ‰ª•Âú®ËøôÈáåÂ∞ùËØïÊÅ¢Â§çUIÔºåÊØîÂ¶ÇÈáçÊñ∞ÊòæÁ§∫ÈÄâÈ°π
                    // displayChoices();
                    // nextButton.disabled = true;
                    return; // ÈòªÊ≠¢ÂêéÁª≠ÊâßË°å
                }

                console.log(`[handleChoiceClick] Confirmed valid selection: "${choiceText}" (Index: ${choiceIndex})`);

                setLoading(true);
                choicesContainer.innerHTML = ''; // Ê∏ÖÈô§ÈÄâÈ°π
                try {
                    const promptText = JSON.stringify({
                        player_choice: choiceText
                    });

                    // Ê∑ªÂä†Âà∞ÂéÜÂè≤
                    conversationHistory.push({
                        role: "user",
                        parts: [{ text: `ÈÄâÊã©‰∫Ü: "${choiceText}"` }]
                    });

                    // ÂáÜÂ§áAPIÂéÜÂè≤
                    const choicePromptHistoryForApi = [
                        ...conversationHistory.slice(0, -1),
                        { role: "user", parts: [{ text: promptText }] }
                    ];

                    // Ë∞ÉÁî®API
                    const response = await callLLMApi_Galgame(choicePromptHistoryForApi);
                    processGameResponse(response);

                } catch (error) {
                    console.error("[handleChoiceClick] Error during API call or response processing:", error);
                    showGameError(`Â§ÑÁêÜÈÄâÊã©Êó∂Âá∫Èîô: ${error.message}`);
                    setLoading(false);
                    // ÈîôËØØÊÅ¢Â§çÔºöÈáçÊñ∞ÊòæÁ§∫ÈÄâÈ°π
                    try {
                        console.log("[handleChoiceClick Error Recovery] Attempting to re-display choices.");
                        displayChoices(); // Á°Æ‰øùÊ≠§Êó∂ currentTurnChoices ‰ªçÁÑ∂ÊòØÊ≠£Á°ÆÁöÑ
                        nextButton.disabled = true; // Á°Æ‰øùÊåâÈíÆÁ¶ÅÁî®
                    } catch (displayError) {
                        console.error("[handleChoiceClick Error Recovery] Failed to re-display choices:", displayError);
                    }
                }
            }

            // Â§ÑÁêÜÈÄâÊã©ÁÇπÂáª
            // Â§ÑÁêÜÈÄâÊã©ÁÇπÂáª (Êé•Êî∂ÊñáÊú¨ÂíåÁ¥¢Âºï‰Ωú‰∏∫ÂèÇÊï∞ - Â¢ûÂä†Èò≤Âæ°ÊÄßËµãÂÄº)
            async function handleChoiceClick(incomingChoiceText, incomingChoiceIndex) { // ‰ΩøÁî®‰∏çÂêåÁöÑÂèÇÊï∞Âêç
                // --- Èò≤Âæ°ÊÄßËµãÂÄºÂπ∂Ê£ÄÊü• ---
                const localChoiceText = incomingChoiceText;
                const localChoiceIndex = incomingChoiceIndex;
                console.log(`[handleChoiceClick START] Received incomingChoiceText: "${incomingChoiceText}" (type: ${typeof incomingChoiceText})`);
                console.log(`[handleChoiceClick START] Copied to localChoiceText: "${localChoiceText}" (type: ${typeof localChoiceText})`);
                console.log(`[handleChoiceClick START] Received incomingChoiceIndex: ${incomingChoiceIndex}, Copied to localChoiceIndex: ${localChoiceIndex}`);
                // --- Ê£ÄÊü•ÁªìÊùü ---

                if (isLoading) {
                    console.log("[handleChoiceClick] Loading... Click ignored.");
                    return;
                }

                // --- ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáèËøõË°åÊ£ÄÊü• ---
                if (typeof localChoiceText !== 'string' || localChoiceText.trim() === '') {
                    console.error("[handleChoiceClick] ERROR: Invalid localChoiceText after copy:", localChoiceText);
                    showGameError("ÂÜÖÈÉ®ÈîôËØØÔºöÂ§ÑÁêÜÈÄâÈ°πÊó∂ÊñáÊú¨Êó†Êïà(Êú¨Âú∞ÂâØÊú¨)„ÄÇ");
                    return;
                }
                // --- Ê£ÄÊü•ÁªìÊùü ---

                console.log(`[handleChoiceClick] Confirmed valid selection using local copy: "${localChoiceText}" (Index: ${localChoiceIndex})`); // ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáèËÆ∞ÂΩï
                console.log("[handleChoiceClick] Current conversationHistory before modification:", JSON.stringify(conversationHistory));


                setLoading(true);
                choicesContainer.innerHTML = '';
                try {
                    // --- ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáè ---
                    const promptText = JSON.stringify({
                        player_choice: localChoiceText // ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáè
                    });

                    // ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáèÊ∑ªÂä†Âà∞ÂéÜÂè≤
                    conversationHistory.push({
                        role: "user",
                        parts: [{ text: `ÈÄâÊã©‰∫Ü: "${localChoiceText}"` }] // ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáè
                    });

                    // ‰ΩøÁî®Â±ÄÈÉ®ÂèòÈáèÂáÜÂ§áAPIÂéÜÂè≤
                    const choicePromptHistoryForApi = [
                        ...conversationHistory.slice(0, -1),
                        { role: "user", parts: [{ text: promptText }] }
                    ];
                    console.log("[handleChoiceClick] History being sent to API:", JSON.stringify(choicePromptHistoryForApi));


                    // Ë∞ÉÁî®API
                    const response = await callLLMApi_Galgame(choicePromptHistoryForApi);
                    processGameResponse(response); // Ê≥®ÊÑèÔºöËøôÈáå userPromptText Â∫îËØ•Â∑≤ÁªèË¢´Â§ÑÁêÜÔºå‰ΩÜ‰∏∫‰øùÊåÅ‰∏ÄËá¥ÊÄßÔºå review processGameResponse ÁöÑË∞ÉÁî®ÊñπÂºè

                } catch (error) {
                    console.error("[handleChoiceClick] Error during API call or response processing:", error);
                    showGameError(`Â§ÑÁêÜÈÄâÊã©Êó∂Âá∫Èîô: ${error.message}`);
                    setLoading(false);
                    try {
                        console.log("[handleChoiceClick Error Recovery] Attempting to re-display choices.");
                        displayChoices();
                        nextButton.disabled = true;
                    } catch (displayError) {
                        console.error("[handleChoiceClick Error Recovery] Failed to re-display choices:", displayError);
                    }
                }
                // Ê≥®ÊÑèÔºöprocessGameResponse Â∫îËØ•Â§ÑÁêÜ setLoading(false)
            }

            // Â§ÑÁêÜ‰∏ã‰∏ÄÊ≠•ÊåâÈíÆÁÇπÂáª
            // Â§ÑÁêÜ‰∏ã‰∏ÄÊ≠•ÊåâÈíÆÁÇπÂáª
            async function handleNextButtonClick() {
                if (isLoading) return; // Èò≤Ê≠¢Âä†ËΩΩÊó∂ÈáçÂ§çÁÇπÂáª

                if (!isGameStarted) {
                    // --- ÂàùÂßãÂåñÊ∏∏ÊàèÈÄªËæë (‰øùÊåÅ‰∏çÂèò) ---
                    try {
                        if (!currentApiKey || !currentModel) {
                            showGameError("ËØ∑ÂÖàÈÖçÁΩÆAPIËÆæÁΩÆÔºÅ");
                            return;
                        }
                        setLoading(true);
                        await initializeGame(); // Ê≥®ÊÑè: initializeGame ÂÜÖÈÉ®Â∫îËØ•Ë∞ÉÁî® processGameResponse
                        isGameStarted = true;
                        toggleHistoryBtn.disabled = false;
                        // nextButton ÁöÑÁä∂ÊÄÅÁî± initializeGame ÈáåÁöÑ processGameResponse ËÆæÁΩÆ
                    } catch (error) {
                        showGameError(`Ê∏∏ÊàèÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`);
                        setLoading(false); // ÂàùÂßãÂåñÂ§±Ë¥•‰πüË¶ÅËß£Èô§Âä†ËΩΩ
                    }
                    // setLoading(false) Â∫îËØ•Áî± initializeGame/processGameResponse ÁÆ°ÁêÜ
                    // --- ÂàùÂßãÂåñÁªìÊùü ---
                } else if (currentSegmentIndex < currentDialogueSegments.length - 1) {
                    // --- ÊòæÁ§∫‰∏ã‰∏ÄÊÆµÂØπËØù ---
                    currentSegmentIndex++;
                    displayDialogueSegment(currentSegmentIndex);

                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúÄÂêé‰∏ÄÊÆµ (ÂàöÂàöÊòæÁ§∫ÁöÑËøô‰∏ÄÊÆµ)
                    if (currentSegmentIndex === currentDialogueSegments.length - 1) {
                        // ÊòØÊúÄÂêé‰∏ÄÊÆµÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÈÄâÈ°π
                        if (currentTurnChoices && currentTurnChoices.length > 0) {
                            // ÊúâÈÄâÈ°πÔºöÊòæÁ§∫ÈÄâÈ°πÂπ∂Á¶ÅÁî®‚ÄúÁªßÁª≠‚ÄùÊåâÈíÆ
                            displayChoices();
                            nextButton.disabled = true;
                            nextButton.textContent = 'ËØ∑ÈÄâÊã©'; // ÂèØÈÄâÔºöÊõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
                            console.log("Â∑≤ÊòæÁ§∫ÊúÄÂêéÁâáÊÆµÂπ∂ÊúâÈÄâÈ°πÔºåÁ¶ÅÁî®ÁªßÁª≠ÊåâÈíÆ„ÄÇ");
                        } else {
                            // ÊòØÊúÄÂêé‰∏ÄÊÆµ‰ΩÜÊó†ÈÄâÈ°πÔºö‰øùÊåÅ‚ÄúÁªßÁª≠‚ÄùÊåâÈíÆÂèØÁî®ÔºåÊñáÊú¨Êîπ‰∏∫‚Äú‰∏ã‰∏ÄÊ≠•‚Äù
                            nextButton.disabled = false;
                            nextButton.textContent = '‰∏ã‰∏ÄÊ≠•';
                            console.log("Â∑≤ÊòæÁ§∫ÊúÄÂêéÁâáÊÆµÊó†ÈÄâÈ°πÔºåÊåâÈíÆ‰∏∫‰∏ã‰∏ÄÊ≠•„ÄÇ");
                        }
                    } else {
                        // ‰∏çÊòØÊúÄÂêé‰∏ÄÊÆµÔºö‰øùÊåÅ‚ÄúÁªßÁª≠‚ÄùÊåâÈíÆÂèØÁî®
                        nextButton.disabled = false;
                        nextButton.textContent = 'ÁªßÁª≠';
                    }
                    // --- ‰∏ã‰∏ÄÊÆµÂØπËØùÁªìÊùü ---
                } else {
                    // --- ËØ∑Ê±Ç‰∏ã‰∏ÄÂõûÂêà (ÂΩìÂâçÂ∑≤ÊòØÊúÄÂêé‰∏ÄÊÆµ‰∏îÊó†ÈÄâÈ°π) ---
                    console.log("ÁÇπÂáª‰∏ã‰∏ÄÊ≠•ÔºåËØ∑Ê±ÇÊñ∞ÂõûÂêà...");
                    setLoading(true);
                    try {
                        // ‰ΩøÁî®Êõ¥ÊòéÁ°ÆÁöÑÂä®‰ΩúÊåáÁ§∫ÔºåÈÅøÂÖçÊ≠ß‰πâ
                        const promptText = JSON.stringify({ "action": "continue_story" });

                        const nextPromptHistory = [
                            ...conversationHistory, // Á°Æ‰øù conversationHistory ÊòØÊúÄÊñ∞ÁöÑ
                            {
                                role: "user",
                                parts: [{ text: promptText }]
                            }
                        ];

                        const response = await callLLMApi_Galgame(nextPromptHistory);
                        // processGameResponse ‰ºöÂ§ÑÁêÜÊåâÈíÆÁöÑÊñ∞Áä∂ÊÄÅÂíåÊñáÊú¨
                        processGameResponse(response);
                    } catch (error) {
                        showGameError(`Ëé∑Âèñ‰∏ã‰∏ÄÂõûÂêàÊó∂Âá∫Èîô: ${error.message}`);
                        setLoading(false); // Âá∫ÈîôÊó∂Ëß£Èô§Âä†ËΩΩ
                        nextButton.disabled = false; // Âá∫ÈîôÊó∂ÂÖÅËÆ∏ÈáçËØï
                        nextButton.textContent = 'ÈáçËØï';
                    }
                    // setLoading(false) Áî± processGameResponse Âú® finally ‰∏≠Â§ÑÁêÜ
                    // --- ËØ∑Ê±ÇÊñ∞ÂõûÂêàÁªìÊùü ---
                }
            }

            // --- ÂéÜÂè≤Èù¢ÊùøÈÄªËæë ---
            function displayHistory() {
                console.log("ÊòæÁ§∫ÂéÜÂè≤„ÄÇÊï∞Èáè:", conversationHistory.length);
                historyContent.innerHTML = '';

                if (conversationHistory.length === 0) {
                    historyContent.innerHTML = '<div class="history-empty">Ê≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ</div>';
                    return;
                }

                // ÂàÜÊûêÂéÜÂè≤Âπ∂ÊòæÁ§∫
                const historyPairs = [];
                let userMessage = null;

                conversationHistory.forEach((item, idx) => {
                    if (item.isSetup || item.isErrorFallback) return; // Ë∑≥ËøáÂàùÂßãËÆæÁΩÆÂíåÈîôËØØÂõûÈÄÄ

                    if (item.role === 'user') {
                        userMessage = item;
                    } else if (item.role === 'model' && userMessage) {
                        try {
                            // Ëß£ÊûêÊ®°ÂûãÂìçÂ∫î
                            const modelText = item.parts[0].text;
                            let modelData;
                            try {
                                modelData = JSON.parse(modelText.replace(/```json\s*|\s*```/g, ''));
                            } catch (error) {
                                console.error("ÂéÜÂè≤ËÆ∞ÂΩïJSONËß£ÊûêÈîôËØØ:", error);
                                modelData = { dialogue_segments: [{ speaker: "Á≥ªÁªü", text: "Ëß£ÊûêÈîôËØØ" }] };
                            }

                            historyPairs.push({
                                user: userMessage,
                                model: { ...item, parsedData: modelData }
                            });

                            userMessage = null;
                        } catch (error) {
                            console.error("Â§ÑÁêÜÂéÜÂè≤ËÆ∞ÂΩïÊó∂Âá∫Èîô:", error);
                        }
                    }
                });

                // Ê∏≤ÊüìÂéÜÂè≤ÂØπËØù
                historyPairs.forEach((pair, idx) => {
                    const entry = document.createElement('div');
                    entry.className = 'history-entry';

                    // Áî®Êà∑Ê∂àÊÅØ
                    try {
                        let userContent = pair.user.parts[0].text;
                        // Â¶ÇÊûúÊòØJSONÊ†ºÂºèÁöÑÈÄâÊã©ÔºåËß£ÊûêÂÆÉ
                        try {
                            const userJson = JSON.parse(userContent);
                            if (userJson.player_choice) {
                                userContent = `ÈÄâÊã©‰∫Ü: "${userJson.player_choice}"`;
                            }
                        } catch (e) {
                            // ‰∏çÊòØJSONÔºå‰ΩøÁî®ÂéüÂßãÊñáÊú¨
                        }

                        const userHeader = document.createElement('div');
                        userHeader.className = 'history-role-user';
                        userHeader.textContent = playerName || 'Áé©ÂÆ∂';

                        const userText = document.createElement('div');
                        userText.className = 'history-text';
                        userText.textContent = userContent;

                        entry.appendChild(userHeader);
                        entry.appendChild(userText);
                    } catch (error) {
                        console.error("Ê∏≤ÊüìÁî®Êà∑ÂéÜÂè≤Êó∂Âá∫Èîô:", error);
                    }

                    // Ê®°ÂûãÂìçÂ∫î
                    try {
                        if (pair.model && pair.model.parsedData) {
                            const modelData = pair.model.parsedData;

                            // Ê∑ªÂä†ÂØπËØùÁâáÊÆµ
                            if (modelData.dialogue_segments && modelData.dialogue_segments.length > 0) {
                                const dialogues = document.createElement('div');
                                dialogues.className = 'history-dialogues';

                                modelData.dialogue_segments.forEach(segment => {
                                    const dialogueSegment = document.createElement('div');
                                    dialogueSegment.className = 'history-dialogue-segment';

                                    const speaker = document.createElement('span');
                                    speaker.className = 'segment-speaker';
                                    speaker.textContent = segment.speaker || 'ÊóÅÁôΩ';

                                    const text = document.createElement('span');
                                    text.className = 'segment-text';
                                    text.innerHTML = DOMPurify.sanitize(marked.parse(segment.text || ""));

                                    dialogueSegment.appendChild(speaker);
                                    dialogueSegment.appendChild(text);
                                    dialogues.appendChild(dialogueSegment);
                                });

                                entry.appendChild(dialogues);
                            }
                        }
                    } catch (error) {
                        console.error("Ê∏≤ÊüìÊ®°ÂûãÂéÜÂè≤Êó∂Âá∫Èîô:", error);
                    }

                    historyContent.appendChild(entry);
                });

                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                historyContent.scrollTop = historyContent.scrollHeight;
            }

            // --- ËßíËâ≤Ê®°ÊùøÂ§ÑÁêÜ ---
            function handleCharacterTemplateChange() {
                const templateKey = characterTemplateSelect.value;
                if (!templateKey) return;

                const template = characterTemplates[templateKey];
                if (!template) return;

                aiPersonaInput.value = template.persona;
            }

            // --- APIÂØÜÈí•ÊòæÁ§∫ÂàáÊç¢ ---
            function toggleApiKeyVisibility() {
                const currentType = apiKeyInput.getAttribute('type');
                if (currentType === 'password') {
                    apiKeyInput.setAttribute('type', 'text');
                    toggleApiKeyVisibilityBtn.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                } else {
                    apiKeyInput.setAttribute('type', 'password');
                    toggleApiKeyVisibilityBtn.textContent = 'üëÅÔ∏è';
                }
            }

            // --- ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô® ---
            function setupEventListeners() {
                // ÈÖçÁΩÆÈù¢Êùø
                toggleConfigBtn.addEventListener('click', toggleConfigPanel);
                closeConfigBtn.addEventListener('click', toggleConfigPanel);
                saveConfigBtn.addEventListener('click', () => {
                    saveConfig();
                    configPanel.classList.remove('visible');
                });
                toggleApiKeyVisibilityBtn.addEventListener('click', toggleApiKeyVisibility);
                fetchModelsBtn.addEventListener('click', fetchLLMModels);
                // ËßíËâ≤Ê®°ÊùøÈÄâÊã©
                characterTemplateSelect.addEventListener('change', handleCharacterTemplateChange);

                // ÊµãËØïAPIÂØÜÈí•
                document.getElementById('test-key-btn').addEventListener('click', testApiKey);

                // Áé©ÂÆ∂ÂõæÁâá‰∏ä‰º†
                playerImageUpload.addEventListener('change', () => {
                    handleImageUpload(
                        playerImageUpload,
                        playerImagePreview,
                        clearPlayerImageBtn,
                        (val) => playerImageBase64 = val
                    );
                });

                clearPlayerImageBtn.addEventListener('click', () => {
                    clearImageUpload(
                        playerImageUpload,
                        playerImagePreview,
                        clearPlayerImageBtn,
                        (val) => playerImageBase64 = val
                    );
                });

                // AIÂõæÁâá‰∏ä‰º†
                aiImageUpload.addEventListener('change', () => {
                    handleImageUpload(
                        aiImageUpload,
                        aiImagePreview,
                        clearAiImageBtn,
                        (val) => aiImageBase64 = val
                    );
                });

                clearAiImageBtn.addEventListener('click', () => {
                    clearImageUpload(
                        aiImageUpload,
                        aiImagePreview,
                        clearAiImageBtn,
                        (val) => aiImageBase64 = val
                    );
                });

                // Ê∏∏ÊàèÊéßÂà∂
                nextButton.addEventListener('click', handleNextButtonClick);
                toggleHistoryBtn.addEventListener('click', toggleHistoryPanel);
                closeHistoryBtn.addEventListener('click', toggleHistoryPanel);

                // Ëá™Âä®‰øùÂ≠òËæìÂÖ•ÂèòÊõ¥Ôºà‰ΩøÁî®Èò≤ÊäñÔºâ
                const debouncedSaveConfig = debounce(saveConfig, 1000);
                const configInputs = document.querySelectorAll('#config-panel input, #config-panel textarea, #config-panel select');
                configInputs.forEach(input => {
                    input.addEventListener('change', debouncedSaveConfig);
                });

                // ÈîÆÁõòÂø´Êç∑ÈîÆ
                document.addEventListener('keydown', (e) => {
                    // Â¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫ÈÄâÊã©ÊàñÂéÜÂè≤Èù¢ÊùøÔºå‰∏çÂ§ÑÁêÜÂø´Êç∑ÈîÆ
                    if (historyPanel.classList.contains('visible') ||
                        configPanel.classList.contains('visible') ||
                        choicesContainer.children.length > 0) {
                        return;
                    }

                    if ((e.key === ' ' || e.key === 'Enter') && !nextButton.disabled) {
                        e.preventDefault();
                        nextButton.click();
                    }
                });
            }

            // --- APIÊµãËØïÂäüËÉΩ ---
            async function testApiKey() {
                const testKeyButtonElement = document.getElementById('test-key-btn');
                const apiKey = apiKeyInput.value.trim();
                const baseApiUrl = apiUrlInput.value.trim() || DEFAULT_API_URL_GALGAME;

                if (!apiKey) {
                    showGameError("ËØ∑ËæìÂÖ•APIÂØÜÈí•ÔºÅ");
                    keyStatusSpan.textContent = "Êú™Êèê‰æõAPIÂØÜÈí•";
                    keyStatusSpan.className = "error";
                    return;
                }

                // ÊòæÁ§∫ÊµãËØï‰∏≠Áä∂ÊÄÅ
                keyStatusSpan.textContent = "Ê≠£Âú®ÊµãËØï...";
                keyStatusSpan.className = "testing";
                testKeyButtonElement.disabled = true;

                try {
                    let testUrl;
                    let testBody;
                    let headers = { 'Content-Type': 'application/json' };

                    if (baseApiUrl.includes('generativelanguage.googleapis.com')) {
                        // Gemini APIÊµãËØï
                        testUrl = `${baseApiUrl.replace(/\/$/, '')}/v1beta/models?key=${apiKey}`;
                        // ‰∏çÈúÄË¶ÅËØ∑Ê±Ç‰ΩìÔºåÂè™Ëé∑ÂèñÊ®°ÂûãÂàóË°®
                    } else if (baseApiUrl.includes('/v1')) {
                        // OpenAIÂÖºÂÆπAPIÊµãËØï
                        testUrl = `${baseApiUrl.replace(/\/v1\/?$/, '')}/v1/models`;
                        headers['Authorization'] = `Bearer ${apiKey}`;
                    } else {
                        throw new Error("‰∏çÊîØÊåÅÁöÑAPI URLÊ†ºÂºè");
                    }

                    const response = await fetch(testUrl, {
                        method: 'GET',
                        headers
                    });

                    const data = await response.json();

                    if (response.ok) {
                        keyStatusSpan.textContent = "ÊúâÊïàÁöÑAPIÂØÜÈí•";
                        keyStatusSpan.className = "valid";
                        saveConfig(); // Ëá™Âä®‰øùÂ≠òÊúâÊïàÈÖçÁΩÆ
                    } else {
                        const errorMessage = data.error?.message || JSON.stringify(data.error) || "Êú™Áü•ÈîôËØØ";
                        keyStatusSpan.textContent = `Êó†Êïà: ${errorMessage}`;
                        keyStatusSpan.className = "invalid";
                    }
                } catch (error) {
                    console.error("ÊµãËØïAPIÂØÜÈí•Êó∂Âá∫Èîô:", error);
                    keyStatusSpan.textContent = `ÈîôËØØ: ${error.message}`;
                    keyStatusSpan.className = "error";
                } finally {
                    testKeyButtonElement.disabled = false;
                }
            }

            // --- ÂàùÂßãÂåñÂíåÊ®°ÂûãÂä†ËΩΩ ---
            async function fetchLLMModels() {
                const apiKey = apiKeyInput.value.trim();
                const baseApiUrl = apiUrlInput.value.trim() || DEFAULT_API_URL_GALGAME;

                if (!apiKey) {
                    showGameError("ËØ∑ËæìÂÖ•APIÂØÜÈí•‰ª•Ëé∑ÂèñÊ®°ÂûãÂàóË°®„ÄÇ");
                    return;
                }

                fetchModelsBtn.disabled = true;
                modelLoadingIndicator.style.display = 'inline-block';

                try {
                    let modelsUrl;
                    let headers = { 'Content-Type': 'application/json' };

                    if (baseApiUrl.includes('generativelanguage.googleapis.com')) {
                        // Gemini API
                        modelsUrl = `${baseApiUrl.replace(/\/$/, '')}/v1beta/models?key=${apiKey}`;
                    } else if (baseApiUrl.includes('/v1')) {
                        // OpenAIÂÖºÂÆπAPI
                        modelsUrl = `${baseApiUrl.replace(/\/v1\/?$/, '')}/v1/models`;
                        headers['Authorization'] = `Bearer ${apiKey}`;
                    } else {
                        throw new Error("‰∏çÊîØÊåÅÁöÑAPI URLÊ†ºÂºè„ÄÇËØ∑‰ΩøÁî®GeminiÊàñOpenAIÂÖºÂÆπÁöÑAPIÂú∞ÂùÄ„ÄÇ");
                    }

                    const response = await fetch(modelsUrl, {
                        method: 'GET',
                        headers
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error?.message || "Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•");
                    }

                    // Ê∏ÖÈô§ÂΩìÂâçÈÄâÈ°π
                    while (modelSelect.options.length > 0) {
                        modelSelect.remove(0);
                    }

                    // Ê∑ªÂä†ÊèêÁ§∫ÈÄâÈ°π
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "-- ÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã --";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    modelSelect.appendChild(defaultOption);

                    // Â§ÑÁêÜ‰∏çÂêåAPIËøîÂõûÁöÑÊ®°ÂûãÂàóË°®Ê†ºÂºè
                    let models = [];
                    if (data.models) {
                        // Gemini APIÊ†ºÂºè
                        models = data.models.map(m => ({
                            id: m.name.split('/').pop(),
                            fullName: m.name
                        }));
                    } else if (data.data) {
                        // OpenAI APIÊ†ºÂºè
                        models = data.data.map(m => ({
                            id: m.id,
                            fullName: m.id
                        }));
                    }

                    // Ê∑ªÂä†Ê®°ÂûãÈÄâÈ°π
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.fullName;
                        option.textContent = model.id;
                        modelSelect.appendChild(option);
                    });

                    modelSelect.disabled = false;
                    showGameError("Â∑≤ÊàêÂäüËé∑ÂèñÊ®°ÂûãÂàóË°®ÔºÅ");
                } catch (error) {
                    console.error("Ëé∑ÂèñÊ®°ÂûãÂàóË°®Êó∂Âá∫Èîô:", error);
                    showGameError(`Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•: ${error.message}`);
                } finally {
                    fetchModelsBtn.disabled = false;
                    modelLoadingIndicator.style.display = 'none';
                }
            }

            // --- ÂàùÂßãÂåñÂ∫îÁî® ---
            // --- ÂàùÂßãÂåñÂ∫îÁî® ---
            // --- ÂàùÂßãÂåñÂ∫îÁî® ---
            // --- ÂàùÂßãÂåñÂ∫îÁî® ---
            function initializeApp() {
                // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô® (This already sets up the listener for toggleConfigBtn)
                setupEventListeners();

                // Á°Æ‰øùËÆæÁΩÆÊåâÈíÆÂú®ÂàùÂßãÂåñÊó∂ÊòØÂèØÁî®ÁöÑ
                if (toggleConfigBtn) {
                    toggleConfigBtn.disabled = false;
                    // REMOVED: Redundant event listener attachment was here.
                    // The listener is correctly added in setupEventListeners.
                    console.log("Toggle config button listener is attached by setupEventListeners.");
                }

                // Âä†ËΩΩ‰øùÂ≠òÁöÑÈÖçÁΩÆ
                loadConfig();

                // ÂàùÂßãÈöêËóèËßíËâ≤sprite
                aiCharacterSprite.classList.add('hidden');
                playerCharacterSprite.classList.add('hidden');

                console.log("AI GalgameÂ∫îÁî®Â∑≤ÂàùÂßãÂåñ");
            }

            // ‰øÆÊîπsetLoadingÂáΩÊï∞ÔºåÁ°Æ‰øùËÆæÁΩÆÊåâÈíÆÂßãÁªàÂèØÁî®
            // ‰øÆÊîπsetLoadingÂáΩÊï∞ÔºåÁ°Æ‰øùËÆæÁΩÆÊåâÈíÆÂßãÁªàÂèØÁî®
            function setLoading(loading) {
                console.log("ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ‰∏∫:", loading);
                isLoading = loading;
                loadingOverlay.classList.toggle('visible', loading);
                const canInteract = currentApiKey && currentModel;

                // Ê£ÄÊü•ÈÄâÈ°πÊòØÂê¶ÂΩìÂâçÊ≠£Âú®ÊòæÁ§∫ (ËØªÂèñDOM)
                const choicesCurrentlyDisplayed = choicesContainer.querySelector('.choice-button') !== null;

                // --- ‰øÆÊîπÂºÄÂßã ---
                // ÊåâÈíÆÂ∫îËØ•Á¶ÅÁî®ÔºåÂ¶ÇÊûúÔºö
                // 1. Ê≠£Âú®Âä†ËΩΩ
                // 2. APIÊú™ÈÖçÁΩÆ
                // 3. Ê∏∏ÊàèÊú™ÂºÄÂßã
                // 4. **ÊúâÈÄâÈ°πÊ≠£Âú®ÊòæÁ§∫** (Áî®Êà∑ÂøÖÈ°ªÈÄâ‰∏Ä‰∏™)
                // ‰∏çÂÜçÂõ†‰∏∫ÊòØÊúÄÂêé‰∏Ä‰∏™ÁâáÊÆµÂ∞±Á¶ÅÁî®ÊåâÈíÆ
                nextButton.disabled = loading || !canInteract || !isGameStarted || choicesCurrentlyDisplayed;
                // --- ‰øÆÊîπÁªìÊùü ---

                // ÂéÜÂè≤ÊåâÈíÆÂíåÂÖ∂‰ªñÊéßÂà∂
                toggleHistoryBtn.disabled = loading || !canInteract || !isGameStarted;
                document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = loading);
            }

            // ÂêØÂä®Â∫îÁî®
            initializeApp();
        });
    </script>
</body>

</html>